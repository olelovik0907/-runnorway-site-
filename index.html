<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunNorway – Finn alle løp i Norge. Ett sted. Én kalender.</title>

  <meta name="theme-color" content="#116D6B" />
  <link rel="icon" href="assets/logo-32.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/logo-180.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --brand:#116D6B; --accent:#F3C316; }
    html,body{ background:#fff; color:#0f172a; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .btn-brand{ background:var(--accent); color:#111827; }
    .btn-brand:hover{ background:#d6aa10; }
    .btn-ghost{ background:rgba(255,255,255,.9); color:var(--brand); }
    .btn-ghost:hover{ background:#fff; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; }
    .link-brand{ color:var(--brand); }
    .link-brand:hover{ text-decoration:underline; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:60; }
    .modal{ background:#fff; width:min(1000px,92vw); max-height:88vh; border-radius:16px; overflow:auto; }
    .modal-header{ position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; z-index:1; }
    .pill{ border:1px solid #e5e7eb; border-radius:9999px; padding:.5rem .9rem; font-weight:600; }
    .badge-premium{ background:rgba(243,195,22,.18); color:#7a5a00; border:1px solid rgba(243,195,22,.5); border-radius:9999px; padding:.15rem .5rem; font-size:.72rem; font-weight:700; }
    .icon-btn{ display:inline-flex; align-items:center; gap:.4rem; }
    .heart{ width:18px; height:18px; display:inline-block; vertical-align:-2px; }
    .tab-active{ background:#f3f4f6; }
    .field{ display:block }
    .field > span{ display:block; font-size:.85rem; font-weight:600; color:#334155 }
    .field > input, .field > select, .field > textarea{ margin-top:.25rem; width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.55rem .75rem }
    .grid-fit{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; border:1px solid #e5e7eb; border-radius:9999px; padding:.25rem .6rem; font-size:.82rem }
  </style>
</head>

<body class="antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto h-16 px-4 flex items-center justify-between">
      <a href="#home" class="flex items-center gap-2 font-bold text-xl link-brand">
        <img src="assets/logo-48.png" alt="RunNorway" class="h-8 w-auto" />
        RunNorway
      </a>
      <nav class="hidden md:flex items-center gap-8 font-semibold link-brand">
        <a href="#arrangementer">Program</a>
        <a href="#resultater">Resultater</a>
        <a href="#vaer">Vær</a>
        <a href="#kontakt">Kontakt</a>
        <a href="#faq">FAQ</a>
      </nav>
      <div class="flex items-center gap-2">
        <button id="openRegister" class="hidden sm:inline-block rounded-full border px-4 py-2 font-semibold text-[var(--brand)] hover:bg-slate-50">Registrer løp</button>
        <button id="openProfile" class="hidden sm:inline-block rounded-full border px-4 py-2 font-semibold text-[var(--brand)] hover:bg-slate-50">Profil</button>
        <a href="#resultater" class="hidden sm:inline-block btn-brand px-4 py-2 rounded-full font-semibold">Resultater</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section id="home" class="relative bg-[var(--brand)] text-white">
    <div class="max-w-7xl mx-auto px-4 py-28 sm:py-36 text-center">
      <img src="assets/logo-192.png" alt="RunNorway" class="mx-auto h-20 mb-6"/>
      <h1 class="text-4xl sm:text-6xl font-extrabold leading-tight">RunNorway</h1>
      <p class="mt-4 text-lg sm:text-2xl">Finn alle løp i Norge. Ett sted. Én kalender.</p>
      <div class="mt-8 flex flex-wrap justify-center gap-3">
        <a href="#arrangementer" class="btn-brand px-6 py-3 rounded-full font-semibold">Se program</a>
        <a href="#resultater" class="btn-ghost px-6 py-3 rounded-full font-semibold">Finn ditt resultat</a>
        <button id="openProfileHero" class="btn-ghost px-6 py-3 rounded-full font-semibold">Opprett profil</button>
      </div>

      <div class="max-w-3xl mx-auto mt-12">
        <p id="nextRaceLabel" class="text-white/95 text-lg font-semibold"></p>
      </div>
      <div class="max-w-3xl mx-auto grid grid-cols-4 gap-4 text-center mt-3">
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="d" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Dager</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="h" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Timer</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="m" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Min</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="s" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Sek</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Arrangementer -->
  <section id="arrangementer" class="py-16 bg-slate-50">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-4">Kommende arrangementer</h2>

      <div class="inline-flex rounded-2xl bg-white shadow p-1 mb-4" role="tablist" aria-label="Visning">
        <button id="tab-list" class="px-4 py-2 rounded-xl font-semibold tab-active" role="tab" aria-selected="true" aria-controls="panel-list">Liste</button>
        <button id="tab-cal" class="px-4 py-2 rounded-xl font-semibold" role="tab" aria-selected="false" aria-controls="panel-cal">Kalender</button>
        <button id="tab-map" class="px-4 py-2 rounded-xl font-semibold" role="tab" aria-selected="false" aria-controls="panel-map">Kart</button>
      </div>

      <div class="card p-4 sm:p-6">
        <div class="grid gap-3 sm:grid-cols-6 items-end">
          <label class="sm:col-span-2 field">
            <span>Søk</span>
            <input id="q" placeholder="Søk på navn eller sted"/>
          </label>
          <label class="field">
            <span>Måned</span>
            <select id="month"><option value="">Alle</option></select>
          </label>
          <label class="field">
            <span>Region</span>
            <select id="region"><option value="">Alle</option></select>
          </label>
          <label class="field">
            <span>Sorter</span>
            <select id="sort">
              <option value="date">Dato</option>
              <option value="name">Navn</option>
              <option value="premium">Premium først</option>
            </select>
          </label>
          <label class="field">
            <span>Distanse</span>
            <select id="distance">
              <option value="">Alle</option>
              <option value="5">5K</option>
              <option value="10">10K</option>
              <option value="21">21K</option>
              <option value="42">42K</option>
            </select>
          </label>
        </div>
        <div class="mt-4 flex flex-wrap gap-3">
          <button id="resetFilters" class="pill hover:bg-slate-50">Nullstill</button>
          <button id="togglePast" class="pill btn-brand" aria-pressed="false">Vis tidligere løp</button>
          <button id="quick5k" class="pill">5K</button>
          <button id="quick10k" class="pill">10K</button>
          <button id="quick21k" class="pill">21K</button>
          <button id="exportCsv" class="pill">Eksporter CSV</button>
          <button id="openFavorites" class="pill icon-btn"><svg class="heart" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M20.8 8.6c0 5.2-8.8 10.4-8.8 10.4S3.2 13.8 3.2 8.6a4.4 4.4 0 0 1 8-2.4 4.4 4.4 0 0 1 8 2.4z"/></svg> Favoritter</button>
          <button id="openProfileFilters" class="pill">Profil</button>
        </div>
      </div>

      <div id="eventsSummary" class="mt-4 text-slate-600"></div>

      <div id="panel-list" role="tabpanel" aria-labelledby="tab-list" class="mt-4">
        <div id="eventsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6" aria-live="polite"></div>
        <p id="eventsEmpty" class="hidden text-slate-600">Ingen arrangementer matcher filtrene.</p>
      </div>

      <div id="panel-cal" role="tabpanel" aria-labelledby="tab-cal" hidden class="mt-6">
        <div class="flex items-center justify-between mb-3">
          <button id="calPrev" class="rounded-full border px-3 py-2 font-semibold hover:bg-slate-50">Forrige</button>
          <h3 id="calTitle" class="text-xl font-bold"></h3>
          <button id="calNext" class="rounded-full border px-3 py-2 font-semibold hover:bg-slate-50">Neste</button>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
      </div>

      <div id="panel-map" role="tabpanel" aria-labelledby="tab-map" hidden class="mt-6">
        <div id="map" class="w-full h-[520px] rounded-2xl overflow-hidden border"></div>
        <p class="mt-2 text-sm text-slate-600">Tips: klikk på markørene for info og påmeldingslenke.</p>
      </div>
    </div>
  </section>

  <!-- Resultater -->
  <section id="resultater" class="py-16">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-4">Finn ditt resultat</h2>
      <div class="card p-4 sm:p-6">
        <div class="grid sm:grid-cols-3 gap-3">
          <input id="resName" class="rounded-xl border px-3 py-2" placeholder="Navn på løp eller deltaker" />
          <input id="resYear" class="rounded-xl border px-3 py-2" placeholder="År (valgfritt, f.eks. 2025)" />
          <button id="resSearch" class="btn-brand rounded-xl px-4 py-2 font-semibold">Søk resultater</button>
        </div>
        <p class="text-slate-600 mt-3">Vi åpner smarte søk i nye faner.</p>
        <div id="resLinks" class="mt-4 grid gap-2"></div>
      </div>
    </div>
  </section>

  <!-- Vær fast seksjon -->
  <section id="vaer" class="py-16 bg-slate-50">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-4">Værmelding (Oslo – eksempel)</h2>
      <iframe src="https://www.pent.no/Oslo" width="100%" height="600" style="border:none; border-radius:10px;"></iframe>
    </div>
  </section>

  <!-- Kontakt -->
  <section id="kontakt" class="py-16">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)]">Kontakt oss</h2>
      <p class="mt-2 text-slate-700">Spørsmål om løp, samarbeid eller presse? Send oss e-post.</p>
      <div class="mt-6 flex flex-wrap items-center gap-4 justify-center">
        <a class="btn-brand rounded-full px-6 py-3 font-semibold" href="mailto:post@runnorway.no">post@runnorway.no</a>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq" class="py-16 bg-slate-50">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-6 text-center">Ofte stilte spørsmål</h2>
      <details class="card p-4">
        <summary class="cursor-pointer font-semibold text-[var(--brand)]">Hvordan melder jeg på?</summary>
        <p class="mt-2 text-slate-700">Åpne ønsket løp, logg inn eller opprett profil og bekreft påmelding. Om arrangør har ekstern løsning, sendes du videre og påmeldingen markeres i profilen din.</p>
      </details>
    </div>
  </section>

  <footer class="py-10 bg-[var(--brand)] text-white text-center">
    <form id="newsletter" class="max-w-xl mx-auto px-4 flex gap-2 justify-center">
      <input id="newsletterEmail" type="email" required placeholder="din@epost.no" class="w-full max-w-xs px-3 py-2 rounded-lg text-slate-900" />
      <button class="btn-brand rounded-lg px-4 py-2 font-semibold" type="submit">Meld meg på</button>
    </form>
    <p id="newsletterMsg" class="mt-2 text-white/90"></p>
    <p class="mt-4">© <span id="year"></span> RunNorway</p>
  </footer>

  <!-- Modal: Løpsdetaljer -->
  <div id="eventModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <h3 id="modalTitle" class="text-xl font-bold text-[var(--brand)]">Løpsnavn</h3>
        <div class="flex items-center gap-2">
          <button id="modalShare" class="rounded-full border px-3 py-1 icon-btn">Del</button>
          <button id="modalFav" class="rounded-full border px-3 py-1 icon-btn"><svg class="heart" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M20.8 8.6c0 5.2-8.8 10.4-8.8 10.4S3.2 13.8 3.2 8.6a4.4 4.4 0 0 1 8-2.4 4.4 4.4 0 0 1 8 2.4z"/></svg> Favoritt</button>
          <button id="modalEnroll" class="btn-brand rounded-full px-3 py-1 font-semibold">Meld meg på</button>
          <button id="modalClose" class="rounded-full border px-3 py-1">Lukk</button>
        </div>
      </div>
      <div id="modalBody" class="p-5 grid gap-5"></div>
    </div>
  </div>

  <!-- Modal: Favoritter -->
  <div id="favoritesModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <h3 class="text-xl font-bold text-[var(--brand)]">Dine favoritter</h3>
        <button id="favoritesClose" class="rounded-full border px-3 py-1">Lukk</button>
      </div>
      <div id="favoritesBody" class="p-5 grid gap-4"></div>
    </div>
  </div>

  <!-- Modal: Registrer løp (wizard light) -->
  <div id="registerModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <h3 class="text-xl font-bold text-[var(--brand)]">Registrer løp</h3>
        <button id="registerClose" class="rounded-full border px-3 py-1">Lukk</button>
      </div>
      <div class="p-5 grid gap-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <label class="field"><span>Løpsnavn</span><input id="reg_name" /></label>
          <label class="field"><span>Arrangør</span><input id="reg_org" /></label>
          <label class="field"><span>Dato</span><input id="reg_date" type="date" /></label>
          <label class="field"><span>Region</span><input id="reg_region" placeholder="f.eks. Oslo, Vestland" /></label>
          <label class="field sm:col-span-2"><span>Sted</span><input id="reg_loc" placeholder="f.eks. Bygdøy, Oslo" /></label>
          <label class="field"><span>Distanser</span><input id="reg_dist" placeholder="5K, 10K, 21K" /></label>
          <label class="field"><span>Påmeldingslenke</span><input id="reg_signup" placeholder="https://..." /></label>
          <label class="field"><span>Nettside</span><input id="reg_website" placeholder="https://..." /></label>
          <label class="flex items-center gap-2 mt-2"><input id="reg_premium" type="checkbox" class="rounded"/><span>Fremhev som premium</span></label>
        </div>
        <div class="flex justify-end gap-2">
          <button id="reg_saveDraft" class="pill">Lagre utkast</button>
          <button id="reg_publish" class="pill btn-brand">Publiser</button>
        </div>
        <p class="text-sm text-slate-600">Data lagres lokalt for demo. I produksjon kan dette sendes til API eller GitHub-workflow.</p>
      </div>
    </div>
  </div>

  <!-- Modal: Profil -->
  <div id="profileModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h3 class="text-xl font-bold text-[var(--brand)]">Din profil</h3>
          <span id="profileStatus" class="text-sm text-slate-500"></span>
        </div>
        <button id="profileClose" class="rounded-full border px-3 py-1">Lukk</button>
      </div>

      <div class="p-5 grid gap-6">
        <div class="grid lg:grid-cols-2 gap-6">
          <section class="card p-4">
            <h4 class="font-semibold text-[var(--brand)]">Grunninfo</h4>
            <div class="mt-3 grid-fit">
              <label class="field"><span>Fornavn</span><input id="pf_first" /></label>
              <label class="field"><span>Etternavn</span><input id="pf_last" /></label>
              <label class="field"><span>E-post</span><input id="pf_email" type="email" /></label>
              <label class="field"><span>Fødselsår</span><input id="pf_birth" type="number" min="1930" max="2030" /></label>
              <label class="field"><span>Kjønn</span>
                <select id="pf_gender"><option value="">Velg</option><option>M</option><option>F</option><option>Annet</option></select>
              </label>
            </div>
            <div class="mt-3 grid-fit">
              <label class="field"><span>Klubb</span><input id="pf_club" placeholder="navn på klubb (valgfritt)" /></label>
              <label class="field"><span>Treningsgruppe</span><input id="pf_group" placeholder="navn på gruppe (valgfritt)" /></label>
            </div>
          </section>

          <section class="card p-4">
            <h4 class="font-semibold text-[var(--brand)]">Sko og utstyr</h4>
            <div class="mt-3 flex gap-2">
              <input id="gearInput" class="flex-1 rounded-xl border px-3 py-2" placeholder="Legg til modell, f.eks. Nike Pegasus 41" />
              <button id="gearAdd" class="pill">Legg til</button>
            </div>
            <div id="gearList" class="mt-3 flex flex-wrap gap-2"></div>
          </section>
        </div>

        <section class="card p-4">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-[var(--brand)]">Mine løp</h4>
            <div class="text-sm text-slate-600">Status kan settes til Påmeldt eller Fullført</div>
          </div>
          <div id="myRaces" class="mt-3 grid gap-3"></div>
        </section>

        <div class="flex justify-between items-center">
          <div id="profileMsg" class="text-sm text-slate-600"></div>
          <div class="flex gap-2">
            <button id="profileExport" class="pill">Eksporter profil (JSON)</button>
            <button id="profileDelete" class="pill">Slett profil</button>
            <button id="profileSave" class="pill btn-brand">Lagre</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Seed-data (fallback) -->
  <script id="events-seed" type="application/json">[
    {"title":"Bergen City Mile","date":"2026-04-12","location":"Bergen sentrum","region":"Vestland","distances":["5K","10K","Familie"],"image":"https://images.unsplash.com/photo-1552674605-db6ffd4facb0?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Oslo FjordRun 10K","date":"2026-05-03","location":"Bygdøy, Oslo","region":"Oslo","distances":["10K"],"image":"https://images.unsplash.com/photo-1541963694-3f4e68f1b7a1?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Trondheim City Trail","date":"2026-05-18","location":"Bymarka, Trondheim","region":"Trøndelag","distances":["8K","16K"],"image":"https://images.unsplash.com/photo-1520975922203-b85e66f2aa64?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Stavanger Strand 5K","date":"2026-06-07","location":"Stavanger sentrum","region":"Rogaland","distances":["5K"],"image":"https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Midnight Sun Half","date":"2026-06-21","location":"Tromsøya","region":"Troms og Finnmark","distances":["21K","10K"],"image":"https://images.unsplash.com/photo-1541625602330-2277a4c46182?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"}
  ]</script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const fmtDate = iso => new Date(iso).toLocaleDateString('no-NO',{year:'numeric',month:'long',day:'numeric'});
    function cityToPentUrl(location){
      if(!location) return null;
      let city = location.split(',')[0].trim();
      const map = {'Bergen sentrum':'Bergen','Stavanger sentrum':'Stavanger','Bymarka, Trondheim':'Trondheim','Tromsøya':'Tromsø'};
      if(map[location]) city = map[location];
      return `https://www.pent.no/${encodeURIComponent(city)}`;
    }
    const geo={'Oslo':[59.9139,10.7522],'Bygdøy, Oslo':[59.9036,10.6785],'Bergen sentrum':[60.39299,5.32415],'Bymarka, Trondheim':[63.401,10.276],'Trondheim':[63.4305,10.3951],'Stavanger sentrum':[58.9690,5.7331],'Tromsøya':[69.6492,18.9553]};

    const LS_EVENTS='rn_events_v1';
    const LS_FAVS='rn_favs_v1';
    const LS_PROFILE='rn_profile_v1';
    const LS_MY_RACES='rn_myraces_v1';

    const state={all:[],showPast:false,filters:{q:'',month:'',region:'',sort:'date',distance:''},view:'list',cal:new Date(), nextTarget:null, nextEvent:null, currentModalEvent:null};

    function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

    async function fetchEqTimingDirect(){
      const url='https://api.eqtiming.com/api/v1/Events';
      const ctrl=new AbortController();
      const t=setTimeout(()=>ctrl.abort(), 8000);
      try{
        const r=await fetch(url,{headers:{accept:'application/json'},mode:'cors',signal:ctrl.signal});
        clearTimeout(t);
        if(!r.ok) throw new Error('status '+r.status);
        const data=await r.json();
        const list = Array.isArray(data) ? data : Array.isArray(data?.Items) ? data.Items : [];
        const onlyNO = list.filter(e => String(e.Country||'').toUpperCase()==='NO' || /Norge|Norway/i.test(e.Country||''));
        const mapped = onlyNO.map(e=>{
          const title = e.Name || e.EventName || e.Title || 'Uten navn';
          const dateIso = String(e.StartDate || e.Date || e.StartTime || '').slice(0,10);
          const city = e.City || e.Location || '';
          const region = e.County || e.Region || '';
          const lat = typeof e.Latitude === 'number' ? e.Latitude : undefined;
          const lng = typeof e.Longitude === 'number' ? e.Longitude : undefined;
          const signup = e.RegistrationUrl || e.SignupUrl || e.Url || '';
          const website = e.Website || e.Homepage || e.Url || '';
          return {
            id:`${title.replace(/[^a-z0-9]+/gi,'-').toLowerCase()}-${dateIso}`,
            title, date:dateIso, location:city, region,
            distances:Array.isArray(e.Distances)?e.Distances:[],
            image:e.ImageUrl || e.LogoUrl || 'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop',
            signup_url:signup, details_url:website, lat, lng, premium:false, _source:'eqtiming'
          };
        }).filter(e => e.date && !Number.isNaN(new Date(e.date)));
        const key=e=>`${e.title}|${e.date}`;
        const seen=new Set(); const cleaned=[];
        for(const e of mapped.sort((a,b)=>new Date(a.date)-new Date(b.date))){
          const k=key(e); if(seen.has(k)) continue; seen.add(k); cleaned.push(e);
        }
        return cleaned;
      }catch(err){ return null; }
    }

    function loadLocalEvents(){
      try{
        const raw=localStorage.getItem(LS_EVENTS);
        if(!raw) return [];
        const arr=JSON.parse(raw);
        return Array.isArray(arr)?arr:[];
      }catch(e){ return []; }
    }
    function saveLocalEvents(arr){
      try{ localStorage.setItem(LS_EVENTS, JSON.stringify(arr)); }catch(e){}
    }

    function getProfile(){
      try{ return JSON.parse(localStorage.getItem(LS_PROFILE)||'null'); }catch(e){ return null; }
    }
    function saveProfile(p){
      localStorage.setItem(LS_PROFILE, JSON.stringify(p));
    }
    function getMyRaces(){
      try{ return JSON.parse(localStorage.getItem(LS_MY_RACES)||'[]'); }catch(e){ return []; }
    }
    function saveMyRaces(arr){
      localStorage.setItem(LS_MY_RACES, JSON.stringify(arr));
    }

    async function loadEvents(){
      const local = loadLocalEvents
