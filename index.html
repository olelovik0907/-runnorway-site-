<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunNorway – Løpsoversikt & Vær</title>
  <meta name="description" content="Oppdatert layout, robust bildehåndtering og forbedret værmodul for RunNorway." />
  <style>
    :root{
      --bg:#0b0d10; /* mørk, lav-kontrast bakgrunn */
      --panel:#11151a;
      --muted:#94a3b8;
      --text:#e6edf3;
      --brand:#22c55e; /* grønn */
      --accent:#38bdf8; /* cyan */
      --danger:#ef4444;
      --radius:18px;
      --shadow:0 8px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, #1e2630 0, transparent 40%),
                  radial-gradient(1000px 500px at 100% 0, #13202d 0, transparent 35%),
                  var(--bg);
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter:saturate(1.2) blur(8px);
      background:linear-gradient(to bottom, rgba(11,13,16,.9), rgba(11,13,16,.6));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px}
    .brand{display:flex; gap:12px; align-items:center}
    .brand h1{font-size:clamp(22px,2.8vw,30px); margin:0; letter-spacing:.2px}
    .brand small{color:var(--muted)}

    /* Sekjonskort */
    .section{margin:28px 0}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    /* Grid for arrangementer */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns: repeat(6, 1fr);} }
    @media (max-width: 620px){ .grid{grid-template-columns: repeat(2, 1fr);} }

    .event-card{
      grid-column: span 4; /* 3 per rad på desktop */
      display:flex; flex-direction:column; height:100%;
      border-radius: calc(var(--radius) - 6px);
      overflow:hidden; border:1px solid rgba(255,255,255,.06);
      background: #0f1318;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .event-card:hover{
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0,0,0,.45);
      border-color: rgba(56,189,248,.35);
    }

    .event-media{
      position:relative; width:100%;
      aspect-ratio: 16/9; /* større, konsistent visning */
      background:#0b0d10;
    }
    .event-media img{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; display:block; filter:saturate(1.05);
      transition: transform .3s ease;
    }
    .event-card:hover .event-media img{ transform: scale(1.02); }

    .event-body{padding:14px 14px 16px}
    .event-title{font-size:clamp(16px,1.6vw,18px); margin:0 0 6px}
    .event-meta{font-size:14px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap}
    .chip{padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.1); font-size:12px}

    /* Værmodul */
    .weather{display:grid; grid-template-columns: 1.2fr 2fr; gap:18px; padding:16px}
    @media (max-width: 800px){ .weather{grid-template-columns: 1fr;}}
    .weather-left{display:flex; flex-direction:column; gap:12px}
    .weather h2{margin:0 0 10px}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .controls input[type="text"]{
      flex:1; min-width:220px;
      padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1);
      background:#0b0f14; color:var(--text);
    }
    .btn{padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:#0c1318; color:var(--text); cursor:pointer}
    .btn.primary{background:linear-gradient(180deg, #1f9a60, #15803d); border-color: rgba(34,197,94,.5)}
    .btn.ghost{background:transparent}

    .current{
      display:flex; align-items:center; gap:14px;
      padding:14px; border:1px solid rgba(255,255,255,.08); border-radius:14px;
      background:linear-gradient(180deg, rgba(34,197,94,.08), rgba(56,189,248,.06));
    }
    .current .big{font-size:42px; font-weight:700}

    .hours{
      display:grid; grid-template-columns: repeat(12, 1fr); gap:8px; padding:10px;
      border:1px dashed rgba(255,255,255,.12); border-radius:12px;
      overflow-x:auto;
    }
    .hour{display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px; border-radius:10px; background:#0b0f14}
    .hour small{color:var(--muted)}

    footer{color:var(--muted); text-align:center; padding:40px 12px}
    a{color:var(--accent)}

    /* Små utility-klasser */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 17c5-2 11-2 16 0" stroke="currentColor" stroke-width="1.6"/>
        <path d="M6 12c4-2 8-2 12 0" stroke="currentColor" stroke-width="1.6"/>
        <circle cx="8.5" cy="6.5" r="2.5" stroke="currentColor" stroke-width="1.6"/>
      </svg>
      <div>
        <h1>RunNorway</h1>
        <small>Arrangementer • Løpsinfo • Vær</small>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- ARRANGEMENTER -->
    <section class="section">
      <div class="panel" id="events-panel">
        <h2 class="sr-only">Kommende arrangementer</h2>
        <div class="grid" id="events-grid" aria-live="polite"></div>
      </div>
    </section>

    <!-- VÆR-APP (forbedret) -->
    <section class="section">
      <div class="panel">
        <div class="weather" id="weather">
          <div class="weather-left">
            <h2>Været der du løper</h2>
            <div class="controls">
              <input type="text" id="place-input" placeholder="Søk sted (f.eks. Oslo)" aria-label="Søk etter sted">
              <button class="btn primary" id="search-btn">Søk</button>
              <button class="btn ghost" id="geo-btn">Bruk min posisjon</button>
            </div>
            <div class="current" id="current" hidden>
              <div class="big" id="current-temp">--°C</div>
              <div>
                <div id="current-summary">–</div>
                <small id="current-meta">Vind: – m/s · Nedbør: –%</small>
              </div>
            </div>
          </div>
          <div>
            <div class="hours" id="hours" aria-label="Neste 12 timer" hidden></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <small>Bygget med ❤️ for løpere. Bilder faller tilbake til <code>assets/default-race.jpg</code> når noe mangler.</small>
  </footer>

  <script>
    // ======== ARRANGEMENTER ========
    // Tips: Bytt ut mockData med fetch fra egen kilde/JSON.
    const defaultImageUrl = "assets/default-race.jpg"; // <- sørg for at denne finnes i repoet

    /** Eksempeldata. Om din kilde mangler image-felt, funker fallback under. */
    const mockData = [
      { title: "Oslo Halvmaraton", date: "2025-09-20", city: "Oslo", distance: "21.1 km", image: "assets/oslo-half.jpg" },
      { title: "Bergen City Marathon", date: "2025-04-26", city: "Bergen", distance: "42.2 km" }, // mangler image
      { title: "Trondheim Night Run", date: "2025-06-14", city: "Trondheim", distance: "10 km", image: "assets/trondheim-night.jpg" },
      { title: "Stavanger Trail", date: "2025-08-09", city: "Stavanger", distance: "30 km", image: "assets/stavanger-trail.jpg" },
      { title: "Nordmarka Ultra", date: "2025-05-31", city: "Oslo", distance: "60 km" }, // mangler image
      { title: "Tromsø Midnight Sun", date: "2025-06-21", city: "Tromsø", distance: "21.1 km", image: "assets/tromso-midnight.jpg" }
    ];

    function createEventCard(ev){
      const card = document.createElement('article');
      card.className = 'event-card';

      const media = document.createElement('div');
      media.className = 'event-media';

      const img = document.createElement('img');
      // Fallback når feltet mangler eller er tomt
      const src = ev.image && String(ev.image).trim() ? ev.image : defaultImageUrl;
      if(src === defaultImageUrl && (!ev.image || !String(ev.image).trim())){
        console.warn("arrangement uten image:", ev.title);
      }
      img.src = src;
      img.alt = ev.title ? `Bilde fra ${ev.title}` : 'Løpsbilde';
      img.loading = 'lazy';

      // Fallback også ved lastingsfeil (404 etc.)
      img.addEventListener('error', () => {
        if(img.dataset.fallbackApplied) return;
        console.warn("bilde mangler/feil – bruker default:", ev.title);
        img.dataset.fallbackApplied = '1';
        img.src = defaultImageUrl;
      });

      media.appendChild(img);

      const body = document.createElement('div');
      body.className = 'event-body';

      const h3 = document.createElement('h3');
      h3.className = 'event-title';
      h3.textContent = ev.title || 'Ukjent arrangement';

      const meta = document.createElement('div');
      meta.className = 'event-meta';
      const d = new Date(ev.date);
      const dateStr = isFinite(d) ? d.toLocaleDateString('nb-NO', {weekday:'short', day:'2-digit', month:'short', year:'numeric'}) : 'Dato TBA';
      meta.innerHTML = `
        <span class="chip" title="Dato">${dateStr}</span>
        <span class="chip" title="By">${ev.city || 'Norge'}</span>
        <span class="chip" title="Distanse">${ev.distance || '—'}</span>
      `;

      body.append(h3, meta);
      card.append(media, body);
      return card;
    }

    function renderEvents(events){
      const grid = document.getElementById('events-grid');
      grid.textContent = '';
      events.forEach(ev => grid.appendChild(createEventCard(ev)));
    }

    // Kall ved load (erstatt mockData ved behov)
    renderEvents(mockData);

    // ======== VÆR-APP (Open-Meteo, ingen API-nøkkel) ========
    const placeInput = document.getElementById('place-input');
    const searchBtn = document.getElementById('search-btn');
    const geoBtn = document.getElementById('geo-btn');
    const currentEl = document.getElementById('current');
    const hoursEl = document.getElementById('hours');
    const tempEl = document.getElementById('current-temp');
    const summaryEl = document.getElementById('current-summary');
    const metaEl = document.getElementById('current-meta');

    async function geocode(q){
      const url = new URL('https://geocoding-api.open-meteo.com/v1/search');
      url.searchParams.set('name', q);
      url.searchParams.set('count', '1');
      url.searchParams.set('language', 'nb');
      const res = await fetch(url);
      if(!res.ok) throw new Error('Geokoding feilet');
      const json = await res.json();
      if(!json.results || !json.results.length) throw new Error('Fant ikke sted');
      const r = json.results[0];
      return {lat:r.latitude, lon:r.longitude, name:r.name, admin:r.admin1 || '', country:r.country || ''};
    }

    async function getWeather(lat, lon){
      const url = new URL('https://api.open-meteo.com/v1/forecast');
      url.searchParams.set('latitude', String(lat));
      url.searchParams.set('longitude', String(lon));
      url.searchParams.set('current_weather', 'true');
      url.searchParams.set('hourly', 'temperature_2m,precipitation_probability,weathercode,windspeed_10m');
      url.searchParams.set('forecast_days', '2');
      url.searchParams.set('timezone', 'auto');
      const res = await fetch(url);
      if(!res.ok) throw new Error('Klarte ikke hente vær');
      return res.json();
    }

    function codeToText(code){
      // Minimal mapping (Open-Meteo værekoder)
      const map = {
        0:'Klar himmel', 1:'For det meste klart', 2:'Delvis skyet', 3:'Skyet',
        45:'Tåke', 48:'Rimet tåke',
        51:'Lett yr', 53:'Yr', 55:'Kraftig yr',
        61:'Lett regn', 63:'Regn', 65:'Kraftig regn',
        71:'Lett snø', 73:'Snø', 75:'Kraftig snø',
        80:'Regnbyger', 81:'Kraftige regnbyger', 82:'Meget kraftige regnbyger',
        95:'Tordenvær', 96:'Tordenvær m/hagel', 99:'Kraftig tordenvær m/hagel'
      };
      return map[code] || 'Vær';
    }

    function renderWeather(data){
      if(!data) return;
      const c = data.current_weather;
      const hourly = data.hourly;
      tempEl.textContent = `${Math.round(c.temperature)}°C`;
      summaryEl.textContent = codeToText(c.weathercode);

      // Finn nærmeste indeks i hourly for nåtid
      const idx = hourly.time.findIndex(t => new Date(t).getTime() >= Date.now());
      const base = idx === -1 ? 0 : idx;

      const wind = hourly.windspeed_10m[base];
      const precipProb = hourly.precipitation_probability[base];
      metaEl.textContent = `Vind: ${Math.round(wind)} m/s · Nedbør: ${precipProb ?? 0}%`;

      currentEl.hidden = false;

      // Neste 12 timer
      hoursEl.textContent = '';
      for(let i=base; i<Math.min(base+12, hourly.time.length); i++){
        const t = new Date(hourly.time[i]);
        const cell = document.createElement('div');
        cell.className = 'hour';
        const temp = Math.round(hourly.temperature_2m[i]);
        const code = hourly.weathercode[i];
        const pp = hourly.precipitation_probability[i];
        cell.innerHTML = `
          <small>${t.toLocaleTimeString('nb-NO',{hour:'2-digit'})}</small>
          <div>${temp}°</div>
          <small>${pp ?? 0}%</small>
        `;
        cell.title = codeToText(code);
        hoursEl.appendChild(cell);
      }
      hoursEl.hidden = false;
    }

    async function loadForPlace(q){
      try{
        searchBtn.disabled = true;
        const loc = await geocode(q);
        const data = await getWeather(loc.lat, loc.lon);
        renderWeather(data);
      }catch(err){
        console.error(err);
        alert('Kunne ikke hente vær for det stedet. Prøv et annet søk.');
      }finally{
        searchBtn.disabled = false;
      }
    }

    searchBtn.addEventListener('click', () => {
      const q = placeInput.value.trim();
      if(q) loadForPlace(q);
    });
    placeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); searchBtn.click(); }});

    geoBtn.addEventListener('click', () => {
      if(!navigator.geolocation){ alert('Geolokasjon støttes ikke i nettleseren.'); return; }
      geoBtn.disabled = true;
      navigator.geolocation.getCurrentPosition(async pos => {
        try{
          const {latitude:lat, longitude:lon} = pos.coords;
          const data = await getWeather(lat, lon);
          renderWeather(data);
        }catch(err){ console.error(err); alert('Kunne ikke hente vær for posisjonen.'); }
        finally{ geoBtn.disabled = false; }
      }, err => { console.warn(err); alert('Fikk ikke tilgang til posisjon.'); geoBtn.disabled = false; }, {enableHighAccuracy:true, timeout:8000});
    });

    // Valgfritt: last vær for Oslo ved første besøk
    loadForPlace('Oslo').catch(()=>{});
  </script>
</body>
</html>
