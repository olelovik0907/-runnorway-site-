<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunNorway ‚Äì Finn alle l√∏p i Norge. Ett sted. √ân kalender.</title>

  <meta name="theme-color" content="#116D6B" />
  <link rel="icon" href="assets/logo-32.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/logo-180.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --brand:#116D6B; --accent:#F3C316; }
    html,body{ background:#fff; color:#0f172a; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .btn-brand{ background:var(--accent); color:#111827; }
    .btn-brand:hover{ background:#d6aa10; }
    .btn-ghost{ background:rgba(255,255,255,.9); color:var(--brand); }
    .btn-ghost:hover{ background:#fff; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; }
    .link-brand{ color:var(--brand); }
    .link-brand:hover{ text-decoration:underline; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:60; }
    .modal{ background:#fff; width:min(960px,92vw); max-height:88vh; border-radius:16px; overflow:auto; }
    .modal-header{ position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; z-index:1; }
    .pill{ border:1px solid #e5e7eb; border-radius:9999px; padding:.5rem .9rem; font-weight:600; }
    .badge-premium{ background:rgba(243,195,22,.18); color:#7a5a00; border:1px solid rgba(243,195,22,.5); border-radius:9999px; padding:.15rem .5rem; font-size:.72rem; font-weight:700; }
    .icon-btn{ display:inline-flex; align-items:center; gap:.4rem; }
    .heart{ width:18px; height:18px; display:inline-block; vertical-align:-2px; }
    .card p { line-height: 1.55; }
    /* Kompakt v√¶r */
.wx { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
.wx-chip { display:flex; align-items:center; gap:.4rem; padding:.35rem .55rem; border:1px solid #e5e7eb; border-radius:9999px; font-size:.8rem; background:#fff; }
.wx-day { font-weight:600; }
.wx-temp { font-variant-numeric: tabular-nums; }
.wx-icon { width:18px; height:18px; }
.wx-muted { color:#64748b; }
.wx-more { margin-top:.5rem; font-size:.8rem; }
  </style>

    /* Mobilvennlige modaler */
    @media (max-width: 640px){
      .modal { width: 100vw; height: 92vh; border-radius: 12px; }
      .modal-header { position: sticky; top: 0; }
    }
  </style>
</head>

<body class="antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto h-16 px-4 flex items-center justify-between">
      <a href="#home" class="flex items-center gap-2 font-bold text-xl link-brand">
        <img src="assets/logo-48.png" alt="RunNorway" class="h-8 w-auto" />
        RunNorway
      </a>
      <nav class="hidden md:flex items-center gap-8 font-semibold link-brand">
        <a href="#arrangementer">Arrangementer</a>
        <a href="#resultater">Resultater</a>
        <a href="#kontakt">Kontakt</a>
        <a href="#faq">Hjelp</a>
        <button id="navFavorites" class="font-semibold">Favoritter</button>
      </nav>
      <div class="flex items-center gap-2">
        <button id="openRegister" class="hidden sm:inline-block rounded-full border px-4 py-2 font-semibold text-[var(--brand)] hover:bg-slate-50">Registrer l√∏p</button>
        <button id="openProfile" class="hidden sm:inline-block rounded-full border px-4 py-2 font-semibold text-[var(--brand)] hover:bg-slate-50">Profil</button>
        <a href="#resultater" class="hidden sm:inline-block btn-brand px-4 py-2 rounded-full font-semibold">Resultater</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section id="home" class="relative bg-[var(--brand)] text-white">
    <div class="max-w-7xl mx-auto px-4 py-14 sm:py-24 text-center">
      <img src="assets/logo-192.png" alt="RunNorway" class="mx-auto h-20 mb-6"/>
      <h1 class="text-4xl sm:text-6xl font-extrabold leading-tight">RunNorway</h1>
      <p class="mt-4 text-lg sm:text-2xl">Finn alle l√∏p i Norge. Ett sted. √ân kalender.</p>
      <div class="mt-8 flex flex-wrap justify-center gap-3">
        <a href="#arrangementer" class="btn-brand px-6 py-3 rounded-full font-semibold">Se program</a>
        <a href="#resultater" class="btn-ghost px-6 py-3 rounded-full font-semibold">Finn ditt resultat</a>
      </div>

      <!-- Neste l√∏p + Nedtelling -->
      <div class="max-w-3xl mx-auto mt-12 flex items-center justify-center gap-3 flex-wrap">
        <p id="nextRaceLabel" class="text-white/95 text-lg font-semibold"></p>
        <a id="nextRaceCta" href="#arrangementer" class="btn-brand px-4 py-2 rounded-full font-semibold">Meld deg p√•</a>
      </div>
      <div class="max-w-3xl mx-auto grid grid-cols-4 gap-4 text-center mt-3">
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="d" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Dager</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="h" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Timer</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="m" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Min</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="s" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Sek</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Arrangementer -->
  <section id="arrangementer" class="py-16 bg-slate-50">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-1">Finn l√∏p</h2>
      <p class="text-slate-600 mb-4">Filtrer etter m√•ned, region eller distanse.</p>

      <div class="inline-flex rounded-2xl bg-white shadow p-1 mb-4" role="tablist" aria-label="Visning">
        <button id="tab-list" class="px-4 py-2 rounded-xl font-semibold" role="tab" aria-selected="true" aria-controls="panel-list">Liste</button>
        <button id="tab-cal" class="px-4 py-2 rounded-xl font-semibold" role="tab" aria-selected="false" aria-controls="panel-cal">Kalender</button>
        <button id="tab-map" class="px-4 py-2 rounded-xl font-semibold" role="tab" aria-selected="false" aria-controls="panel-map">Kart</button>
      </div>

      <div class="card p-4 sm:p-6">
        <div class="grid gap-3 sm:grid-cols-6 items-end">
          <label class="sm:col-span-2">
            <span class="text-sm font-semibold">S√∏k</span>
            <input id="q" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="S√∏k p√• navn eller sted"/>
          </label>
          <label>
            <span class="text-sm font-semibold">M√•ned</span>
            <select id="month" class="mt-1 w-full rounded-xl border px-3 py-2">
              <option value="">Alle</option>
            </select>
          </label>
          <label>
            <span class="text-sm font-semibold">Region</span>
            <select id="region" class="mt-1 w-full rounded-xl border px-3 py-2">
              <option value="">Alle</option>
            </select>
          </label>
          <label>
            <span class="text-sm font-semibold">Sorter</span>
            <select id="sort" class="mt-1 w-full rounded-xl border px-3 py-2">
              <option value="date">Dato</option>
              <option value="name">Navn</option>
              <option value="premium">Premium f√∏rst</option>
            </select>
          </label>
          <div class="flex gap-2">
            <button id="openFavorites" class="pill">Favoritter</button>
            <button id="openProfileSmall" class="pill">Profil</button>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-3">
          <button id="resetFilters" class="pill hover:bg-slate-50">Nullstill</button>
          <button id="togglePast" class="pill btn-brand" aria-pressed="false">Vis tidligere l√∏p</button>
          <button id="quick5k" class="pill">5K</button>
          <button id="quick10k" class="pill">10K</button>
          <button id="quick21k" class="pill">21K</button>
          <button id="exportCsv" class="pill">Eksporter CSV</button>
        </div>
      </div>

      <div id="eventsSummary" class="mt-4 text-slate-600"></div>

      <div id="panel-list" role="tabpanel" aria-labelledby="tab-list" class="mt-4">
        <div id="eventsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6" aria-live="polite"></div>
        <p id="eventsEmpty" class="hidden text-slate-600">Ingen arrangementer matcher filtrene.</p>
      </div>

      <div id="panel-cal" role="tabpanel" aria-labelledby="tab-cal" hidden class="mt-6">
        <div class="flex items-center justify-between mb-3">
          <button id="calPrev" class="rounded-full border px-3 py-2 font-semibold hover:bg-slate-50">Forrige</button>
          <h3 id="calTitle" class="text-xl font-bold"></h3>
          <button id="calNext" class="rounded-full border px-3 py-2 font-semibold hover:bg-slate-50">Neste</button>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
      </div>

      <div id="panel-map" role="tabpanel" aria-labelledby="tab-map" hidden class="mt-6">
        <div id="map" class="w-full h-[520px] rounded-2xl overflow-hidden border"></div>
        <p class="mt-2 text-sm text-slate-600">Tips: klikk p√• mark√∏rene for info og p√•meldingslenke.</p>
      </div>
    </div>
  </section>

  <!-- Resultater -->
  <section id="resultater" class="py-16">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-4">Finn ditt resultat</h2>
      <div class="card p-4 sm:p-6">
        <div class="grid sm:grid-cols-3 gap-3">
          <input id="resName" class="rounded-xl border px-3 py-2" placeholder="Navn p√• l√∏p eller deltaker" />
          <input id="resYear" class="rounded-xl border px-3 py-2" placeholder="√Ör (valgfritt, f.eks. 2025)" />
          <button id="resSearch" class="btn-brand rounded-xl px-4 py-2 font-semibold">S√∏k resultater</button>
        </div>
        <p class="text-slate-700 mt-3">Vi s√∏ker i kjente resultatportaler i nye faner. Velg en av lenkene under.</p>
        <div id="resLinks" class="mt-4 grid gap-2"></div>
      </div>
    </div>
  </section>

  <!-- Kontakt -->
  <section id="kontakt" class="py-16">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)]">Kontakt oss</h2>
      <p class="mt-2 text-slate-700">Sp√∏rsm√•l om l√∏p, samarbeid eller presse? Send oss e-post.</p>
      <div class="mt-6 flex flex-wrap items-center gap-4 justify-center">
        <a class="btn-brand rounded-full px-6 py-3 font-semibold" href="mailto:post@runnorway.no">post@runnorway.no</a>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq" class="py-16 bg-slate-50">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-6 text-center">Ofte stilte sp√∏rsm√•l</h2>
      <details class="card p-4">
        <summary class="cursor-pointer font-semibold text-[var(--brand)]">Hvordan melder jeg p√•?</summary>
        <p class="mt-2 text-slate-700">Trykk inn p√• l√∏pet du vil delta p√• og velg ¬´Delta¬ª. Mangler du profil, blir du bedt om √• opprette den f√∏rst.</p>
      </details>
    </div>
  </section>

  <footer class="py-10 bg-[var(--brand)] text-white text-center">
    <form id="newsletter" class="max-w-xl mx-auto px-4 flex gap-2 justify-center">
      <input id="newsletterEmail" type="email" required placeholder="din@epost.no" class="w-full max-w-xs px-3 py-2 rounded-lg text-slate-900" />
      <button class="btn-brand rounded-lg px-4 py-2 font-semibold" type="submit">Meld meg p√•</button>
    </form>
    <p id="newsletterMsg" class="mt-2 text-white/90"></p>
    <p class="mt-4">¬© <span id="year"></span> RunNorway</p>
  </footer>

  <!-- Modal: L√∏psdetaljer -->
  <div id="eventModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <h3 id="modalTitle" class="text-xl font-bold text-[var(--brand)]">L√∏psnavn</h3>
        <div class="flex items-center gap-2">
          <button id="modalShare" class="rounded-full border px-3 py-1 icon-btn">Del</button>
          <button id="modalFav" class="rounded-full border px-3 py-1 icon-btn"><svg class="heart" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M20.8 8.6c0 5.2-8.8 10.4-8.8 10.4S3.2 13.8 3.2 8.6a4.4 4.4 0 0 1 8-2.4 4.4 4.4 0 0 1 8 2.4z"/></svg> Favoritt</button>
          <button id="modalClose" class="rounded-full border px-3 py-1">Lukk</button>
        </div>
      </div>
      <div id="modalBody" class="p-5 grid gap-5"></div>
    </div>
  </div>

  <!-- Modal: Favoritter -->
  <div id="favoritesModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <h3 class="text-xl font-bold text-[var(--brand)]">Dine favoritter</h3>
        <button id="favoritesClose" class="rounded-full border px-3 py-1">Lukk</button>
      </div>
      <div id="favoritesBody" class="p-5 grid gap-4"></div>
    </div>
  </div>

  <!-- Modal: Registrer l√∏p (wizard light) -->
  <div id="registerModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <h3 class="text-xl font-bold text-[var(--brand)]">Registrer l√∏p</h3>
        <button id="registerClose" class="rounded-full border px-3 py-1">Lukk</button>
      </div>
      <div class="p-5 grid gap-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <label><span class="text-sm font-semibold">L√∏psnavn</span><input id="reg_name" class="mt-1 w-full rounded-xl border px-3 py-2" /></label>
          <label><span class="text-sm font-semibold">Arrang√∏r</span><input id="reg_org" class="mt-1 w-full rounded-xl border px-3 py-2" /></label>
          <label><span class="text-sm font-semibold">Dato</span><input id="reg_date" type="date" class="mt-1 w-full rounded-xl border px-3 py-2" /></label>
          <label><span class="text-sm font-semibold">Region</span><input id="reg_region" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="f.eks. Oslo, Vestland" /></label>
          <label class="sm:col-span-2"><span class="text-sm font-semibold">Sted</span><input id="reg_loc" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="f.eks. Bygd√∏y, Oslo" /></label>
          <label><span class="text-sm font-semibold">Distanser</span><input id="reg_dist" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="5K, 10K, 21K" /></label>
          <label><span class="text-sm font-semibold">P√•meldingslenke</span><input id="reg_signup" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="https://..." /></label>
          <label><span class="text-sm font-semibold">Nettside</span><input id="reg_website" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="https://..." /></label>
          <label class="flex items-center gap-2 mt-2"><input id="reg_premium" type="checkbox" class="rounded"/><span>Fremhev som premium</span></label>
        </div>
        <div class="flex justify-end gap-2">
          <button id="reg_saveDraft" class="pill">Lagre utkast</button>
          <button id="reg_publish" class="pill btn-brand">Publiser</button>
        </div>
        <p class="text-sm text-slate-600">Demo: data lagres lokalt i nettleseren. I produksjon kan dette sendes til et API/GitHub-workflow.</p>
      </div>
    </div>
  </div>

  <!-- Modal: Profil -->
  <div id="profileModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <h3 class="text-xl font-bold text-[var(--brand)]">Din profil</h3>
        <button id="profileClose" class="rounded-full border px-3 py-1">Lukk</button>
      </div>
      <div class="p-5 grid gap-6">
        <div class="grid sm:grid-cols-2 gap-4">
          <label><span class="text-sm font-semibold">Navn</span><input id="pr_name" class="mt-1 w-full rounded-xl border px-3 py-2" required/></label>
          <label><span class="text-sm font-semibold">E-post</span><input id="pr_email" type="email" class="mt-1 w-full rounded-xl border px-3 py-2" required/></label>
          <label><span class="text-sm font-semibold">Klubb</span><input id="pr_club" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="f.eks. SK Vidar"/></label>
          <label><span class="text-sm font-semibold">Treningsgruppe</span><input id="pr_group" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="f.eks. Torsdagsjoggen"/></label>
          <label class="sm:col-span-2"><span class="text-sm font-semibold">L√∏pesko</span><input id="pr_shoes" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Merke/modell"/></label>
          <label class="sm:col-span-2"><span class="text-sm font-semibold">Om deg (valgfritt)</span><textarea id="pr_notes" rows="3" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="M√•l, styrker, skadehistorikk‚Ä¶"></textarea></label>
        </div>

        <div>
          <div class="flex items-center justify-between">
            <h4 class="text-lg font-bold text-[var(--brand)]">L√∏pshistorikk</h4>
            <button id="addHistoryBtn" class="pill">Legg til</button>
          </div>
          <div id="historyList" class="mt-3 grid gap-2"></div>
        </div>

        <div>
          <h4 class="text-lg font-bold text-[var(--brand)]">Dine p√•meldinger</h4>
          <div id="registrationsList" class="mt-3 grid gap-2"></div>
        </div>

        <div class="flex justify-end gap-2">
          <button id="profileDelete" class="pill">Slett profil</button>
          <button id="profileSave" class="pill btn-brand">Lagre</button>
        </div>
        <p class="text-sm text-slate-600">Data lagres lokalt i nettleseren (localStorage) i demo.</p>
      </div>
    </div>
  </div>

  <!-- Seed-data (fallback) -->
  <script id="events-seed" type="application/json">[
    {"title":"Bergen City Mile","date":"2026-04-12","location":"Bergen sentrum","region":"Vestland","distances":["5K","10K","Familie"],"image":"https://images.unsplash.com/photo-1552674605-db6ffd4facb0?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Oslo FjordRun 10K","date":"2026-05-03","location":"Bygd√∏y, Oslo","region":"Oslo","distances":["10K"],"image":"https://images.unsplash.com/photo-1541963694-3f4e68f1b7a1?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Trondheim City Trail","date":"2026-05-18","location":"Bymarka, Trondheim","region":"Tr√∏ndelag","distances":["8K","16K"],"image":"https://images.unsplash.com/photo-1520975922203-b85e66f2aa64?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Stavanger Strand 5K","date":"2026-06-07","location":"Stavanger sentrum","region":"Rogaland","distances":["5K"],"image":"https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Midnight Sun Half","date":"2026-06-21","location":"Troms√∏ya","region":"Troms og Finnmark","distances":["21K","10K"],"image":"https://images.unsplash.com/photo-1541625602330-2277a4c46182?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"}
  ]</script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Utils og global state
    document.getElementById("year").textContent = new Date().getFullYear();
    const fmtDate = iso => new Date(iso).toLocaleDateString('no-NO',{year:'numeric',month:'long',day:'numeric'});
    const cityToPentUrl = location => {
      if(!location) return null;
      let city = location.split(',')[0].trim();
      const map = {'Bergen sentrum':'Bergen','Stavanger sentrum':'Stavanger','Bymarka, Trondheim':'Trondheim','Troms√∏ya':'Troms√∏'};
      if(map[location]) city = map[location];
      return `https://www.pent.no/${encodeURIComponent(city)}`;
    };
    const geo={'Oslo':[59.9139,10.7522],'Bygd√∏y, Oslo':[59.9036,10.6785],'Bergen sentrum':[60.39299,5.32415],'Bymarka, Trondheim':[63.401,10.276],'Trondheim':[63.4305,10.3951],'Stavanger sentrum':[58.9690,5.7331],'Troms√∏ya':[69.6492,18.9553]};

    const LS_EVENTS='rn_events_v1';
    const LS_FAVS='rn_favs_v1';
    const LS_PROFILE='rn_profile_v1';

    const state={all:[],showPast:false,filters:{q:'',month:'',region:'',sort:'date'},view:'list',cal:new Date(), nextTarget:null, nextEvent:null, currentModalEvent:null};

    const monthKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

    // Bilder (sikre defaults)
    const CITY_IMAGES = {
      'Oslo': 'https://images.unsplash.com/photo-1551462147-ff29053f1972?q=80&w=1200&auto=format&fit=crop',
      'Bergen': 'https://images.unsplash.com/photo-1552674605-db6ffd4facb0?q=80&w=1200&auto=format&fit=crop',
      'Trondheim': 'https://images.unsplash.com/photo-1520975922203-b85e66f2aa64?q=80&w=1200&auto=format&fit=crop',
      'Stavanger': 'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop',
      'Troms√∏': 'https://images.unsplash.com/photo-1541625602330-2277a4c46182?q=80&w=1200&auto=format&fit=crop'
    };

    const DIST_IMAGES = {
      'trail': 'https://images.unsplash.com/photo-1520975922203-b85e66f2aa64?q=80&w=1200&auto=format&fit=crop',
      'city':  'https://images.unsplash.com/photo-1541963694-3f4e68f1b7a1?q=80&w=1200&auto=format&fit=crop',
      '5k':    'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop',
      '10k':   'https://images.unsplash.com/photo-1541963694-3f4e68f1b7a1?q=80&w=1200&auto=format&fit=crop',
      '21k':   'https://images.unsplash.com/photo-1541625602330-2277a4c46182?q=80&w=1200&auto=format&fit=crop'
    };

    const SEASON_IMAGES = {
      winter: 'https://images.unsplash.com/photo-1541625602330-2277a4c46182?q=80&w=1200&auto=format&fit=crop',
      spring: 'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop',
      summer: 'https://images.unsplash.com/photo-1541963694-3f4e68f1b7a1?q=80&w=1200&auto=format&fit=crop',
      autumn: 'https://images.unsplash.com/photo-1552674605-db6ffd4facb0?q=80&w=1200&auto=format&fit=crop'
    };

    function safeImageForEvent(ev) {
      if (ev.image && String(ev.image).trim() !== "") return ev.image;

      const title = (ev.title || '').toLowerCase();
      const loc   = (ev.location || '').toLowerCase();
      const reg   = (ev.region || '').toLowerCase();
      const dists = Array.isArray(ev.distances) ? ev.distances.map(x=>String(x).toLowerCase()) : [];

      const cityGuess =
        /oslo/.test(loc) || /oslo/.test(reg) ? 'Oslo' :
        /bergen/.test(loc) || /bergen/.test(reg) ? 'Bergen' :
        /trondheim/.test(loc) || /tr√∏ndelag/.test(reg) ? 'Trondheim' :
        /stavanger/.test(loc) || /rogaland/.test(reg) ? 'Stavanger' :
        /troms√∏/.test(loc) || /troms/.test(reg) ? 'Troms√∏' : null;

      if (cityGuess && CITY_IMAGES[cityGuess]) return CITY_IMAGES[cityGuess];

      if (dists.some(x=>/trail|terreng|sti/.test(x)) || /trail|terreng|sti/.test(title)) {
        return DIST_IMAGES.trail;
      }
      if (dists.some(x=>/21|halve|half/.test(x)) || /21k|half/.test(title)) {
        return DIST_IMAGES['21k'];
      }
      if (dists.some(x=>/10/.test(x)) || /10k/.test(title)) {
        return DIST_IMAGES['10k'];
      }
      if (dists.some(x=>/5/.test(x)) || /5k/.test(title)) {
        return DIST_IMAGES['5k'];
      }
      if (/sentrum|city|downtown|by/.test(loc)) {
        return DIST_IMAGES.city;
      }

      let month = 0;
      try { month = new Date(ev.date).getMonth(); } catch(e) { month = 0; }
      const season =
        (month===11 || month<=1) ? 'winter' :
        (month<=4) ? 'spring' :
        (month<=7) ? 'summer' : 'autumn';
      return SEASON_IMAGES[season];
    }

    // EQ Timing
    async function fetchEqTimingDirect(){
      const url='https://api.eqtiming.com/api/v1/Events';
      const ctrl=new AbortController();
      const t=setTimeout(()=>ctrl.abort(), 8000);
      try{
        const r=await fetch(url,{headers:{accept:'application/json'},mode:'cors',signal:ctrl.signal});
        clearTimeout(t);
        if(!r.ok) throw new Error('status '+r.status);
        const data=await r.json();
        const list = Array.isArray(data) ? data : Array.isArray(data?.Items) ? data.Items : [];
        const onlyNO = list.filter(e => String(e.Country||'').toUpperCase()==='NO' || /Norge|Norway/i.test(e.Country||''));
        const mapped = onlyNO.map(e=>{
          const title = e.Name || e.EventName || e.Title || 'Uten navn';
          const dateIso = String(e.StartDate || e.Date || e.StartTime || '').slice(0,10);
          const city = e.City || e.Location || '';
          const region = e.County || e.Region || '';
          const lat = typeof e.Latitude === 'number' ? e.Latitude : undefined;
          const lng = typeof e.Longitude === 'number' ? e.Longitude : undefined;
          const signup = e.RegistrationUrl || e.SignupUrl || e.Url || '';
          const website = e.Website || e.Homepage || e.Url || '';
          return {
            id:`${title.replace(/[^a-z0-9]+/gi,'-').toLowerCase()}-${dateIso}`,
            title, date:dateIso, location:city, region,
            distances:Array.isArray(e.Distances)?e.Distances:[],
            image:e.ImageUrl || e.LogoUrl || '',  // lar v√¶re tom s√• safeImageForEvent tar over
            signup_url:signup, details_url:website, lat, lng, premium:false, _source:'eqtiming'
          };
        }).filter(e => e.date && !Number.isNaN(new Date(e.date)));
        const key=e=>`${e.title}|${e.date}`;
        const seen=new Set(); const cleaned=[];
        for(const e of mapped.sort((a,b)=>new Date(a.date)-new Date(b.date))){
          const k=key(e); if(seen.has(k)) continue; seen.add(k); cleaned.push(e);
        }
        return cleaned;
      }catch(err){ return null; }
    }

    // Local storage helpers
    const loadLocalEvents = () => {
      try{ const raw=localStorage.getItem(LS_EVENTS); return raw? JSON.parse(raw):[] }catch(e){ return [] }
    };
    const saveLocalEvents = arr => { try{ localStorage.setItem(LS_EVENTS, JSON.stringify(arr)); }catch(e){} };

    const loadProfile = () => {
      try{ const raw=localStorage.getItem(LS_PROFILE); return raw? JSON.parse(raw): null }catch(e){ return null }
    };
    const saveProfile = obj => { try{ localStorage.setItem(LS_PROFILE, JSON.stringify(obj)); }catch(e){} };
    const clearProfile = () => { try{ localStorage.removeItem(LS_PROFILE); }catch(e){} };

    // Init events
    async function loadEvents(){
      const local = loadLocalEvents();
      let fromEq = await fetchEqTimingDirect();
      if(Array.isArray(fromEq) && fromEq.length){
        state.all = dedupe([...local, ...fromEq]);
      } else {
        const seed = JSON.parse(document.getElementById('events-seed').textContent);
        state.all = dedupe([...local, ...seed]);
      }
      renderFilters();
      setView('list');
      initCountdownToNext();
    }
    function dedupe(list){
      const out=[], seen=new Set();
      for(const e of list){
        const id = e.id || `${e.title}-${e.date}`;
        const key = id.toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);
        out.push({...e, id});
      }
      return out;
    }

    // Countdown
    function initCountdownToNext(){
      const today=new Date(); today.setHours(0,0,0,0);
      const upcoming = state.all
        .map(e=>({...e,_d:new Date(e.date)}))
        .filter(e=>!isNaN(e._d) && e._d>=today)
        .sort((a,b)=>a._d-b._d);
      state.nextEvent = upcoming[0] || null;
      const label = document.getElementById('nextRaceLabel');
      if(state.nextEvent){
        state.nextTarget = new Date(state.nextEvent.date+'T09:00:00');
        label.textContent = `Neste l√∏p: ${state.nextEvent.title} ‚Äî ${fmtDate(state.nextEvent.date)}`;
        const cta = document.getElementById('nextRaceCta');
        if(cta){ cta.onclick = (e)=>{ e.preventDefault(); openEvent(state.nextEvent); }; }
      } else {
        const fallback = new Date(); fallback.setDate(fallback.getDate()+60);
        state.nextTarget = fallback;
        label.textContent = `Neste l√∏p: annonseres snart`;
      }
      tick(); clearInterval(window.__countInt__); window.__countInt__=setInterval(tick,1000);
    }
    function tick(){
      const target = state.nextTarget || new Date();
      const now=new Date(); let diff=Math.max(0,target-now);
      const d=Math.floor(diff/86400000); diff-=d*86400000;
      const h=Math.floor(diff/3600000);  diff-=h*3600000;
      const m=Math.floor(diff/60000);    diff-=m*60000;
      const s=Math.floor(diff/1000);
      document.getElementById("d").textContent=d;
      document.getElementById("h").textContent=h;
      document.getElementById("m").textContent=m;
      document.getElementById("s").textContent=s;
    }

    // Filters
    function renderFilters(){
      const months=new Set(), regions=new Set();
      for(const ev of state.all){ const dd=new Date(ev.date); if(!isNaN(dd)) months.add(monthKey(dd)); if(ev.region) regions.add(ev.region); }
      const monthSel=document.getElementById('month'); const regionSel=document.getElementById('region');
      monthSel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
      regionSel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
      for(const m of Array.from(months).sort()){
        const [y,mm]=m.split('-'); const o=document.createElement('option');
        o.value=m; o.textContent=new Date(`${y}-${mm}-01`).toLocaleDateString('no-NO',{month:'long',year:'numeric'});
        monthSel.appendChild(o);
      }
      for(const r of Array.from(regions).sort()){ const o=document.createElement('option'); o.value=r; o.textContent=r; regionSel.appendChild(o); }
    }

    function filtered(){
      const today=new Date(); today.setHours(0,0,0,0);
      let list=[...state.all];
      if(!state.showPast) list=list.filter(e=>new Date(e.date)>=today);
      if(state.filters.q){
        const q=state.filters.q.toLowerCase();
        list=list.filter(e=>`${e.title} ${e.location}`.toLowerCase().includes(q));
      }
      if(state.filters.month){ list=list.filter(e=>monthKey(new Date(e.date))===state.filters.month); }
      if(state.filters.region){ list=list.filter(e=>e.region===state.filters.region); }
      if(state.filters.sort==='name'){ list.sort((a,b)=>a.title.localeCompare(b.title)); }
      else if(state.filters.sort==='premium'){ list.sort((a,b)=> (b.premium?1:0) - (a.premium?0:1) || new Date(a.date)-new Date(b.date)); }
      else { list.sort((a,b)=>new Date(a.date)-new Date(b.date)); }
      return list;
    }

    // List view
    function renderList(){
      const items=filtered(); const grid=document.getElementById('eventsGrid'); const empty=document.getElementById('eventsEmpty');
      grid.innerHTML=''; document.getElementById('eventsSummary').textContent=`Viser ${items.length} arrangementer`;
      if(items.length===0){
        empty.classList.remove('hidden');
        empty.innerHTML = `
          Ingen arrangementer matcher filtrene n√•.
          <button class="ml-2 underline text-[var(--brand)]" id="emptyReset">Nullstill filtre</button>`;
        document.getElementById('emptyReset').onclick = () => {
          state.filters={q:'',month:'',region:'',sort:'date'};
          q.value=''; month.value=''; region.value=''; sort.value='date';
          setView(state.view);
        };
        return;
      } else empty.classList.add('hidden');

      items.forEach((ev, idx)=>{
        const fav = isFav(ev.id);
        const el=document.createElement('article'); el.className='card overflow-hidden';
        el.innerHTML=`
          <div class="relative">
            ${ev.premium ? `<div class="absolute top-3 left-3 badge-premium">Premium</div>`:''}
            <img
              src="${safeImageForEvent(ev)}"
              alt="${ev.title}"
              class="h-44 w-full object-cover"
              loading="lazy"
              decoding="async"
              srcset="${safeImageForEvent(ev)}&w=480 480w, ${safeImageForEvent(ev)}&w=768 768w, ${safeImageForEvent(ev)}&w=1200 1200w"
              sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
              fetchpriority="low"
            />
          </div>
          <div class="p-6">
            <div class="text-xs uppercase tracking-wide text-slate-500">${ev.region||''}</div>
            <h3 class="text-xl font-semibold mt-1 link-brand">${ev.title}</h3>
            <p class="text-sm text-slate-700 mt-1">${fmtDate(ev.date)} ‚Ä¢ ${ev.location}</p>
            <p class="text-sm mt-2">${(ev.distances||[]).join(', ')}</p>

            <div class="mt-3 flex items-center gap-3">
              <button class="btn-brand rounded-full px-4 py-2 text-sm font-semibold" onclick='attemptRegister(${JSON.stringify(ev).replace(/'/g,"&#39;")})'>Delta</button>
              <a class="text-sm link-brand" href="javascript:void(0)" onclick='openEvent(${JSON.stringify(ev).replace(/'/g,"&#39;")})'>Les mer</a>
              <button class="p-2 rounded-full border hover:bg-slate-50" aria-label="Del" onclick='shareEvent(${JSON.stringify(ev).replace(/'/g,"&#39;")})'>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 12v-2a4 4 0 0 1 8 0v2"/><path d="M12 12h8"/><path d="M5 12v6a4 4 0 0 0 8 0v-6"/></svg>
              </button>
              <button class="p-2 rounded-full border hover:bg-slate-50" aria-label="Favoritt" data-favid="${ev.id}" onclick='toggleFav("${ev.id}")'>
                <svg class="heart" viewBox="0 0 24 24" fill="${fav?'#ef4444':'none'}" stroke="#ef4444" stroke-width="2"><path d="M20.8 8.6c0 5.2-8.8 10.4-8.8 10.4S3.2 13.8 3.2 8.6a4.4 4.4 0 0 1 8-2.4 4.4 4.4 0 0 1 8 2.4z"/></svg>
              </button>
            </div>

            <div class="mt-3">
              <button class="rounded-full border px-3 py-1 text-xs font-semibold hover:bg-slate-50" onclick="showInlineWeather(${idx})">Se v√¶r</button>
            </div>

            <div id='inline-weather-${idx}' class='mt-4 hidden'></div>
          </div>`;
        grid.appendChild(el);
      });
    }
// --- V√ÜR: Open-Meteo (kompakt) ---
const WMO = {
  0:  {t:'Klar',        i:'‚òÄÔ∏è'},
  1:  {t:'Lettskyet',   i:'üå§Ô∏è'},
  2:  {t:'Delvis',      i:'‚õÖ'},
  3:  {t:'Overskyet',   i:'‚òÅÔ∏è'},
  45: {t:'T√•ke',        i:'üå´Ô∏è'}, 48:{t:'Rimt√•ke', i:'üå´Ô∏è'},
  51: {t:'Yr',          i:'üå¶Ô∏è'}, 53:{t:'Yr', i:'üå¶Ô∏è'}, 55:{t:'Yr', i:'üå¶Ô∏è'},
  61: {t:'Regn',        i:'üåßÔ∏è'}, 63:{t:'Regn', i:'üåßÔ∏è'}, 65:{t:'Kraftig regn', i:'üåßÔ∏è'},
  66: {t:'Underkj√∏lt',  i:'üå®Ô∏è'}, 67:{t:'Underkj√∏lt', i:'üå®Ô∏è'},
  71: {t:'Sn√∏',         i:'‚ùÑÔ∏è'}, 73:{t:'Sn√∏', i:'‚ùÑÔ∏è'}, 75:{t:'Sn√∏', i:'‚ùÑÔ∏è'},
  80: {t:'Regnbyger',   i:'üå¶Ô∏è'}, 81:{t:'Regnbyger', i:'üå¶Ô∏è'}, 82:{t:'Kraftige byger', i:'üåßÔ∏è'},
  95: {t:'Torden',      i:'‚õàÔ∏è'}, 96:{t:'Torden', i:'‚õàÔ∏è'}, 99:{t:'Torden', i:'‚õàÔ∏è'}
};

function getLatLngForEvent(ev){
  // Bruker eksisterende geo-objekt, evt lat/lng fra data
  return (ev.lat && ev.lng) ? [ev.lat, ev.lng]
       : geo[ev.location] || geo[(ev.location||'').split(',')[0]] || null;
}

async function fetchWeather(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
              `&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum&current_weather=true&timezone=auto`;
  const r = await fetch(url, {headers:{'accept':'application/json'}});
  if(!r.ok) throw new Error('weather '+r.status);
  return r.json();
}

function fmtDayLabel(iso){ // Man, Tir, ...
  const d = new Date(iso);
  return d.toLocaleDateString('no-NO',{weekday:'short'}).replace(/\.$/,'');
}

function renderWeatherBox(container, w, title){
  const cur = w.current_weather;
  const d = w.daily;
  const days = d.time.slice(0,5).map((date, idx)=>({
    date,
    code: d.weathercode[idx],
    tmax: Math.round(d.temperature_2m_max[idx]),
    tmin: Math.round(d.temperature_2m_min[idx]),
    p: typeof d.precipitation_sum[idx]==='number' ? Math.round(d.precipitation_sum[idx]) : 0
  }));

  const curIcon = (WMO[cur.weathercode]||{}).i || '‚ÑπÔ∏è';
  const curTxt  = (WMO[cur.weathercode]||{}).t || 'V√¶r';

  const chips = days.map(day=>{
    const m = WMO[day.code] || {t:'', i:'‚ÑπÔ∏è'};
    return `<span class="wx-chip" title="${m.t}">
      <span class="wx-day">${fmtDayLabel(day.date)}</span>
      <span class="wx-icon" aria-hidden="true">${m.i}</span>
      <span class="wx-temp">${day.tmax}¬∞/${day.tmin}¬∞</span>
      <span class="wx-muted">${day.p} mm</span>
    </span>`;
  }).join('');

  container.innerHTML = `
    <div class="wx" role="group" aria-label="V√¶rmelding">
      <span class="wx-chip" title="${curTxt}">
        <strong>Now</strong>
        <span class="wx-icon" aria-hidden="true">${curIcon}</span>
        <span class="wx-temp">${Math.round(cur.temperature)}¬∞</span>
        <span class="wx-muted">${curTxt}</span>
      </span>
      ${chips}
    </div>
    <div class="wx-more">
      <button class="underline text-[var(--brand)]" type="button" id="wxExpandBtn">Utvid</button>
      <a class="ml-3 underline text-[var(--brand)]" target="_blank" rel="noopener"
         href="https://www.open-meteo.com/en/docs#api">Kilde</a>
    </div>
    <div id="wxExpanded" class="hidden mt-2">
      ${days.map(dy=>{
        const m = WMO[dy.code] || {t:'', i:'‚ÑπÔ∏è'};
        return `<div class="flex items-center gap-2 text-sm">
          <span class="w-12 font-semibold">${fmtDayLabel(dy.date)}</span>
          <span class="wx-icon">${m.i}</span>
          <span class="w-20">${dy.tmax}¬∞/${dy.tmin}¬∞</span>
          <span class="w-16">${dy.p} mm</span>
          <span class="text-slate-600">${m.t}</span>
        </div>`;
      }).join('')}
    </div>
  `;

  const btn = container.querySelector('#wxExpandBtn');
  const exp = container.querySelector('#wxExpanded');
  btn?.addEventListener('click', ()=>{
    const hid = exp.classList.toggle('hidden');
    btn.textContent = hid ? 'Utvid' : 'Skjul';
  });
}

    // Inline weather
    function showInlineWeather(i){
      const items = filtered();
      const ev = items[i]; if(!ev) return;
      const url = cityToPentUrl(ev.location);
      const box = document.getElementById(`inline-weather-${i}`);
      if(!url){ box.innerHTML = `<p class="text-sm text-slate-600">Fant ikke sted for v√¶r.</p>`; }
      else {
        box.innerHTML = `<h4 class="text-[var(--brand)] font-bold mb-2">V√¶rmelding (${ev.location})</h4>
                         <iframe src="${url}" width="100%" height="520" style="border:none; border-radius:10px;"></iframe>`;
      }
      box.classList.remove('hidden'); box.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // Calendar
    const daysInMonth=(y,m)=> new Date(y,m+1,0).getDate();
    function renderCalendar(){
      const current=new Date(state.cal.getFullYear(), state.cal.getMonth(), 1);
      const y=current.getFullYear(), m=current.getMonth();
      document.getElementById('calTitle').textContent=current.toLocaleDateString('no-NO',{month:'long',year:'numeric'});
      const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
      const wk=['Man','Tir','Ons','Tor','Fre','L√∏r','S√∏n'];
      for(const w of wk){ const h=document.createElement('div'); h.className='text-xs font-semibold text-slate-500 text-center'; h.textContent=w; grid.appendChild(h); }
      const firstDow=(new Date(y,m,1).getDay()+6)%7; const dim=daysInMonth(y,m);
      for(let i=0;i<firstDow;i++){ grid.appendChild(document.createElement('div')); }
      const items=filtered();
      for(let day=1; day<=dim; day++){
        const cell=document.createElement('div'); cell.className='rounded-xl bg-white shadow p-2 min-h-[84px]';
        const label=document.createElement('div'); label.className='text-sm font-semibold'; label.textContent=String(day); cell.appendChild(label);
        const dateStr= new Date(y,m,day).toISOString().slice(0,10);
        const todays = items.filter(e=> e.date===dateStr || new Date(e.date).toDateString()===new Date(dateStr).toDateString());
        for(const ev of todays){ const a=document.createElement('div'); a.className='mt-1 text-xs'; a.textContent=ev.title; cell.appendChild(a); }
        grid.appendChild(cell);
      }
    }

    // Map
    let map, markersLayer;
    function ensureMap(){
      if(map) return;
      map=L.map('map'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
      markersLayer=L.layerGroup().addTo(map);
    }
    function renderMap(){
      ensureMap(); markersLayer.clearLayers();
      const items=filtered(); const points=[];
      const lookup=loc=> geo[loc] || geo[(loc||'').split(',')[0]] || null;
      for(const ev of items){
        const latlng=(ev.lat&&ev.lng)?[ev.lat,ev.lng]:lookup(ev.location);
        if(!latlng) continue; points.push(latlng);
        L.marker(latlng).addTo(markersLayer).bindPopup(`<strong>${ev.title}</strong><br>${fmtDate(ev.date)} ‚Ä¢ ${ev.location}`);
      }
      if(points.length){ map.fitBounds(L.latLngBounds(points),{padding:[30,30]}); } else { map.setView([64.5,11.5],5); }
      setTimeout(()=>map.invalidateSize(),0);
    }

    // View switch
    function setView(v){
      state.view=v;
      ['list','cal','map'].forEach(id=>{
        document.getElementById(`tab-${id}`).setAttribute('aria-selected', String(id===v));
        document.getElementById(`panel-${id}`).hidden = id!==v;
      });
      if(v==='list') renderList();
      if(v==='cal') renderCalendar();
      if(v==='map') renderMap();
    }

    // Favoritter
    const getFavs=()=>{ try{ return JSON.parse(localStorage.getItem(LS_FAVS)||'[]'); }catch(e){ return [] } };
    const isFav=id=> getFavs().includes(id);
    function toggleFav(id){
      let favs=getFavs();
      if(favs.includes(id)) favs=favs.filter(x=>x!==id); else favs.push(id);
      localStorage.setItem(LS_FAVS, JSON.stringify(favs));
      document.querySelectorAll(`[data-favid="${CSS.escape(id)}"] svg`).forEach(svg=>{ svg.setAttribute('fill', favs.includes(id)? '#ef4444' : 'none'); });
      renderFavoritesBody();
    }
    function renderFavoritesBody(){
      const body=document.getElementById('favoritesBody');
      const favs=getFavs();
      const map=new Map(state.all.map(e=>[e.id,e]));
      const items=favs.map(id=>map.get(id)).filter(Boolean).sort((a,b)=>new Date(a.date)-new Date(b.date));
      body.innerHTML='';
      if(!items.length){ body.innerHTML='<p class="text-slate-600">Ingen favoritter enn√•.</p>'; return; }
      items.forEach(ev=>{
        const row=document.createElement('div'); row.className='card p-4 flex items-center justify-between gap-4';
        row.innerHTML=`
          <div>
            <div class="text-xs uppercase tracking-wide text-slate-500">${ev.region||''}</div>
            <div class="font-semibold">${ev.title}</div>
            <div class="text-sm text-slate-600">${fmtDate(ev.date)} ‚Ä¢ ${ev.location}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn-brand rounded-full px-3 py-2 text-sm font-semibold" onclick='attemptRegister(${JSON.stringify(ev).replace(/'/g,"&#39;")})'>Delta</button>
            <button class="rounded-full border px-3 py-2 text-sm font-semibold hover:bg-slate-50" onclick="toggleFav('${ev.id}')">Fjern</button>
          </div>
        `;
        body.appendChild(row);
      });
    }

    // Deling
    async function shareEvent(ev){
      const text = `${ev.title} ‚Äî ${fmtDate(ev.date)} ‚Ä¢ ${ev.location}`;
      const url = ev.signup_url || ev.details_url || location.href;
      try{
        if(navigator.share){ await navigator.share({title:ev.title, text, url}); }
        else { await navigator.clipboard.writeText(url); alert('Lenke kopiert'); }
      }catch(e){}
    }

    // Resultater
    document.getElementById('resSearch')?.addEventListener('click', ()=>{
      const name = (document.getElementById('resName').value||'').trim();
      const year = (document.getElementById('resYear').value||'').trim();
      const q = encodeURIComponent([name, year].filter(Boolean).join(' '));
      const engines = [
        { label:'EQ Timing', url:`https://live.eqtiming.com/?search=${q}` },
        { label:'Google (norsk)', url:`https://www.google.com/search?q=${q}+resultater+l√∏p` },
        { label:'Bing', url:`https://www.bing.com/search?q=${q}+resultater+l√∏p` },
        { label:'DuckDuckGo', url:`https://duckduckgo.com/?q=${q}+resultater+l√∏p` }
      ];
      const box = document.getElementById('resLinks'); box.innerHTML='';
      engines.forEach(e=>{
        const a=document.createElement('a'); a.href=e.url; a.target='_blank'; a.rel='noopener';
        a.textContent=`√Öpne i ${e.label}`; a.className='underline text-[var(--brand)]';
        const p=document.createElement('p'); p.appendChild(a); box.appendChild(p);
      });
    });

    // Modaler
    const modalBackdrop = document.getElementById('eventModalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalFav = document.getElementById('modalFav');
    const modalShareBtn = document.getElementById('modalShare');
    document.getElementById('modalClose').addEventListener('click', ()=> modalBackdrop.style.display='none');
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) modalBackdrop.style.display='none'; });

    function openEvent(ev){
      state.currentModalEvent = ev;
      modalTitle.textContent = ev.title;
      const pent = cityToPentUrl(ev.location);
      const g = geo[ev.location] || geo[(ev.location||'').split(',')[0]] || (ev.lat&&ev.lng?[ev.lat,ev.lng]:null);

      modalBody.innerHTML = `
        <div class="grid lg:grid-cols-2 gap-5">
          <div>
            ${ev.premium ? `<div class="badge-premium mb-2 inline-block">Premium</div>`:''}
            <div class="text-sm text-slate-600 mb-1">${ev.region||''}</div>
            <div class="text-lg font-semibold">${fmtDate(ev.date)} ‚Ä¢ ${ev.location||''}</div>
            <div class="mt-2 text-slate-700">${(ev.distances||[]).join(', ')}</div>
            <div class="mt-4 flex flex-wrap gap-3">
              <button class="btn-brand rounded-full px-4 py-2 font-semibold" onclick='attemptRegister(${JSON.stringify(ev).replace(/'/g,"&#39;")})'>Delta</button>
              ${ev.details_url?`<a href="${ev.details_url}" class="rounded-full border px-4 py-2 font-semibold hover:bg-slate-50" target="_blank" rel="noopener">Nettside</a>`:''}
            </div>
            ${pent ? `<h4 class="text-[var(--brand)] font-bold mt-6 mb-2">V√¶rmelding (${ev.location})</h4>
                      <iframe src="${pent}" width="100%" height="420" style="border:none; border-radius:10px;"></iframe>` : ''}
          </div>
          <div><div id="modalMap" class="h-[380px] rounded-2xl border"></div></div>
        </div>
      `;
      modalBackdrop.style.display='flex';
      modalFav.onclick = ()=> toggleFav(ev.id);
      modalShareBtn.onclick = ()=> shareEvent(ev);
      setTimeout(()=>{
        const m = L.map('modalMap', { zoomControl: true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'¬© OpenStreetMap'}).addTo(m);
        if(g){ m.setView(g, 12); L.marker(g, {keyboard:true}).addTo(m); } else { m.setView([64.5,11.5],5); }
      }, 50);
    }

    // Profil: UI wiring
    const profileModal=document.getElementById('profileModal');
    const profileClose=()=> profileModal.style.display='none';
    const openProfile=()=>{ hydrateProfileForm(); renderHistory(); renderRegistrations(); profileModal.style.display='flex'; };
    document.getElementById('openProfile').addEventListener('click', openProfile);
    document.getElementById('openProfileSmall').addEventListener('click', openProfile);
    document.getElementById('profileClose').addEventListener('click', profileClose);
    profileModal.addEventListener('click', e=>{ if(e.target===profileModal) profileClose(); });

    // Profil: form helpers
    function hydrateProfileForm(){
      const p = loadProfile() || {};
      document.getElementById('pr_name').value = p.name || '';
      document.getElementById('pr_email').value = p.email || '';
      document.getElementById('pr_club').value = p.club || '';
      document.getElementById('pr_group').value = p.group || '';
      document.getElementById('pr_shoes').value = p.shoes || '';
      document.getElementById('pr_notes').value = p.notes || '';
    }
    function collectProfileFromForm(){
      return {
        name: document.getElementById('pr_name').value.trim(),
        email: document.getElementById('pr_email').value.trim(),
        club: document.getElementById('pr_club').value.trim(),
        group: document.getElementById('pr_group').value.trim(),
        shoes: document.getElementById('pr_shoes').value.trim(),
        notes: document.getElementById('pr_notes').value.trim(),
        history: (loadProfile()?.history)||[],
        registrations: (loadProfile()?.registrations)||[]
      };
    }

    // Profil: history UI
    function renderHistory(){
      const list=document.getElementById('historyList');
      const p=loadProfile(); const arr=p?.history||[];
      list.innerHTML='';
      if(!arr.length){ list.innerHTML='<p class="text-slate-600">Ingen registrert historikk enn√•.</p>'; return; }
      arr.sort((a,b)=> new Date(b.date)-new Date(a.date));
      arr.forEach((h,idx)=>{
        const row=document.createElement('div'); row.className='card p-3 flex items-center justify-between gap-3';
        row.innerHTML=`<div><div class="font-semibold">${h.race}</div><div class="text-sm text-slate-600">${fmtDate(h.date)} ‚Ä¢ ${h.time||''}</div></div>
                       <button class="rounded-full border px-3 py-1 text-sm hover:bg-slate-50">Fjern</button>`;
        row.querySelector('button').onclick=()=>{ const p=loadProfile(); p.history.splice(idx,1); saveProfile(p); renderHistory(); };
        list.appendChild(row);
      });
    }
    function renderRegistrations(){
      const list=document.getElementById('registrationsList');
      const p=loadProfile(); const arr=p?.registrations||[];
      list.innerHTML='';
      if(!arr.length){ list.innerHTML='<p class="text-slate-600">Ingen p√•meldinger enn√•.</p>'; return; }
      arr.sort((a,b)=> new Date(a.date)-new Date(b.date));
      arr.forEach((r,idx)=>{
        const row=document.createElement('div'); row.className='card p-3 flex items-center justify-between gap-3';
        row.innerHTML=`<div><div class="font-semibold">${r.title}</div><div class="text-sm text-slate-600">${fmtDate(r.date)} ‚Ä¢ ${r.location||''}</div></div>
                       <button class="rounded-full border px-3 py-1 text-sm hover:bg-slate-50">Avmeld</button>`;
        row.querySelector('button').onclick=()=>{ const p=loadProfile(); p.registrations.splice(idx,1); saveProfile(p); renderRegistrations(); };
        list.appendChild(row);
      });
    }

    // Profil: actions
    document.getElementById('profileSave').addEventListener('click', ()=>{
      const p=collectProfileFromForm();
      if(!p.name || !p.email){ alert('Navn og e-post m√• fylles ut.'); return; }
      saveProfile(p);
      alert('Profil lagret');
      renderRegistrations(); renderHistory();
      profileModal.style.display='none';
    });
    document.getElementById('profileDelete').addEventListener('click', ()=>{
      if(confirm('Slette profilen og all lokal data?')){ clearProfile(); renderRegistrations(); renderHistory(); profileModal.style.display='none'; }
    });
    document.getElementById('addHistoryBtn').addEventListener('click', ()=>{
      const race = prompt('L√∏psnavn');
      if(!race) return;
      const date = prompt('Dato (YYYY-MM-DD)');
      if(!date) return;
      const time = prompt('Tid/resultat (valgfritt)');
      const p=loadProfile()||{history:[], registrations:[]};
      p.history = p.history||[]; p.history.push({race, date, time});
      saveProfile(p); renderHistory();
    });

    // P√•melding
    function attemptRegister(ev){
      let p = loadProfile();
      if(!p || !p.name || !p.email){
        openProfile();
        alert('Opprett/lagre profil f√∏rst, s√• kan du melde deg p√•.');
        return;
      }
      p.registrations = p.registrations || [];
      if(p.registrations.some(r=> r.id===ev.id)){
        alert('Du er allerede registrert p√• dette l√∏pet i demoen.');
      } else {
        p.registrations.push({ id: ev.id, title: ev.title, date: ev.date, location: ev.location });
        saveProfile(p);
        alert(`P√•melding registrert i demo: ${ev.title} ‚Äî ${fmtDate(ev.date)}.`);
      }
      renderRegistrations();
    }

    // Registrer-l√∏p (arrang√∏r)
    const regModal=document.getElementById('registerModal');
    document.getElementById('openRegister').addEventListener('click', ()=> regModal.style.display='flex');
    document.getElementById('registerClose').addEventListener('click', ()=> regModal.style.display='none');
    regModal.addEventListener('click', e=>{ if(e.target===regModal) regModal.style.display='none'; });
    function readReg(){
      return {
        title: document.getElementById('reg_name').value.trim(),
        org: document.getElementById('reg_org').value.trim(),
        date: document.getElementById('reg_date').value,
        region: document.getElementById('reg_region').value.trim(),
        location: document.getElementById('reg_loc').value.trim(),
        distances: document.getElementById('reg_dist').value.split(',').map(s=>s.trim()).filter(Boolean),
        signup_url: document.getElementById('reg_signup').value.trim(),
        details_url: document.getElementById('reg_website').value.trim(),
        premium: document.getElementById('reg_premium').checked,
        image: 'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop'
      };
    }
    function saveReg(publish){
      const ev=readReg();
      if(!ev.title || !ev.date){ alert('L√∏psnavn og dato m√• fylles ut.'); return; }
      ev.id = `${ev.title}-${ev.date}`.toLowerCase().replace(/[^a-z0-9]+/g,'-');
      const all = dedupe([...loadLocalEvents().filter(e=>e.id!==ev.id), ev]);
      saveLocalEvents(all);
      state.all = dedupe([...all, ...state.all.filter(x=>x._source==='eqtiming')]);
      setView(state.view);
      regModal.style.display='none';
      alert(publish ? 'L√∏pet er publisert' : 'Utkast lagret');
      ['reg_name','reg_org','reg_date','reg_region','reg_loc','reg_dist','reg_signup','reg_website'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('reg_premium').checked=false;
    }
    document.getElementById('reg_saveDraft').addEventListener('click', ()=> saveReg(false));
    document.getElementById('reg_publish').addEventListener('click', ()=> saveReg(true));

    // Favoritter modal
    const favModal=document.getElementById('favoritesModal');
    document.getElementById('openFavorites').addEventListener('click', ()=>{ renderFavoritesBody(); favModal.style.display='flex'; });
    document.getElementById('favoritesClose').addEventListener('click', ()=> favModal.style.display='none');
    favModal.addEventListener('click', e=>{ if(e.target===favModal) favModal.style.display='none'; });

    // Nav-favoritter-knapp
    document.getElementById('navFavorites')?.addEventListener('click', ()=>{
      renderFavoritesBody();
      document.getElementById('favoritesModal').style.display='flex';
    });

    // Newsletter dummy
    document.getElementById('newsletter').addEventListener('submit', e=>{
      e.preventDefault();
      const email=document.getElementById('newsletterEmail').value.trim();
      if(!email){ return; }
      document.getElementById('newsletterMsg').textContent='Takk for p√•meldingen. Vi sender kun relevante oppdateringer.';
      e.target.reset();
    });

    // Eksport CSV
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const items=filtered();
      const rows=[['Tittel','Dato','Sted','Region','Distanser','P√•melding','Nettside','Premium']];
      for(const e of items){
        rows.push([e.title, e.date, e.location||'', e.region||'', (e.distances||[]).join(' '), e.signup_url||'', e.details_url||'', e.premium?'ja':'nei']);
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='runnorway-eksport.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Quick chips
    document.getElementById('quick5k').addEventListener('click', ()=>{ state.filters.q='5k'; document.getElementById('q').value='5k'; setView(state.view); });
    document.getElementById('quick10k').addEventListener('click', ()=>{ state.filters.q='10k'; document.getElementById('q').value='10k'; setView(state.view); });
    document.getElementById('quick21k').addEventListener('click', ()=>{ state.filters.q='21'; document.getElementById('q').value='21'; setView(state.view); });

    // Tab-tastaturnavigasjon
    document.addEventListener('DOMContentLoaded',()=>{
      loadEvents();

      document.getElementById('q').addEventListener('input',e=>{state.filters.q=e.target.value; setView(state.view);});
      document.getElementById('month').addEventListener('change',e=>{state.filters.month=e.target.value; setView(state.view);});
      document.getElementById('region').addEventListener('change',e=>{state.filters.region=e.target.value; setView(state.view);});
      document.getElementById('sort').addEventListener('change',e=>{state.filters.sort=e.target.value; setView(state.view);});
      document.getElementById('resetFilters').addEventListener('click',()=>{
        state.filters={q:'',month:'',region:'',sort:'date'};
        q.value=''; month.value=''; region.value=''; sort.value='date'; setView(state.view);
      });
      document.getElementById('togglePast').addEventListener('click',e=>{
        state.showPast=!state.showPast; e.currentTarget.setAttribute('aria-pressed', String(state.showPast));
        e.currentTarget.textContent= state.showPast? 'Skjul tidligere l√∏p':'Vis tidligere l√∏p'; setView(state.view);
      });

      document.getElementById('tab-list').addEventListener('click',()=>setView('list'));
      document.getElementById('tab-cal').addEventListener('click',()=>setView('cal'));
      document.getElementById('tab-map').addEventListener('click',()=>setView('map'));
      document.getElementById('calPrev').addEventListener('click',()=>{ state.cal.setMonth(state.cal.getMonth()-1); renderCalendar(); });
      document.getElementById('calNext').addEventListener('click',()=>{ state.cal.setMonth(state.cal.getMonth()+1); renderCalendar(); });

      const tabs = ['list','cal','map'].map(id=>document.getElementById(`tab-${id}`));
      tabs.forEach((btn, i)=>{
        btn.addEventListener('keydown', e=>{
          if(e.key==='ArrowRight'){ e.preventDefault(); tabs[(i+1)%tabs.length].focus(); }
          if(e.key==='ArrowLeft'){ e.preventDefault(); tabs[(i-1+tabs.length)%tabs.length].focus(); }
        });
      });
    });

    // Tilgjengelighet: ESC for √• lukke
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){
        [document.getElementById('eventModalBackdrop'), document.getElementById('favoritesModal'), document.getElementById('registerModal'), document.getElementById('profileModal')]
          .forEach(m=>{ if(m && m.style.display==='flex') m.style.display='none'; });
      }
    });
  </script>
</body>
</html>
