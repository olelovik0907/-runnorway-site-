<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunNorway – Finn alle løp i Norge. Ett sted. Én kalender.</title>

  <meta name="theme-color" content="#116D6B" />
  <link rel="icon" href="assets/logo-32.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/logo-180.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --brand:#116D6B; --accent:#F3C316; }
    html,body{ background:#fff; color:#0f172a; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .btn-brand{ background:var(--accent); color:#111827; }
    .btn-brand:hover{ background:#d6aa10; }
    .btn-ghost{ background:rgba(255,255,255,.9); color:var(--brand); }
    .btn-ghost:hover{ background:#fff; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; }
    .link-brand{ color:var(--brand); }
    .link-brand:hover{ text-decoration:underline; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:60; }
    .modal{ background:#fff; width:min(960px,92vw); max-height:88vh; border-radius:16px; overflow:auto; }
    .modal-header{ position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; z-index:1; }
  </style>
</head>

<body class="antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto h-16 px-4 flex items-center justify-between">
      <a href="#home" class="flex items-center gap-2 font-bold text-xl link-brand">
        <img src="assets/logo-48.png" alt="RunNorway" class="h-8 w-auto" />
        RunNorway
      </a>
      <nav class="hidden md:flex items-center gap-8 font-semibold link-brand">
        <a href="#arrangementer">Program</a>
        <a href="#resultater">Resultater</a>
        <a href="#vaer">Vær</a>
        <a href="#kontakt">Kontakt</a>
        <a href="#faq">FAQ</a>
      </nav>
      <a href="#resultater" class="hidden sm:inline-block btn-brand px-4 py-2 rounded-full font-semibold">Resultater</a>
    </div>
  </header>

  <!-- Hero -->
  <section id="home" class="relative bg-[var(--brand)] text-white">
    <div class="max-w-7xl mx-auto px-4 py-28 sm:py-36 text-center">
      <img src="assets/logo-192.png" alt="RunNorway" class="mx-auto h-20 mb-6"/>
      <h1 class="text-4xl sm:text-6xl font-extrabold leading-tight">RunNorway</h1>
      <p class="mt-4 text-lg sm:text-2xl">Finn alle løp i Norge. Ett sted. Én kalender.</p>
      <div class="mt-8 flex flex-wrap justify-center gap-3">
        <a href="#arrangementer" class="btn-brand px-6 py-3 rounded-full font-semibold">Se program</a>
        <a href="#resultater" class="btn-ghost px-6 py-3 rounded-full font-semibold">Finn ditt resultat</a>
      </div>

      <!-- Neste løp + Nedtelling -->
      <div class="max-w-3xl mx-auto mt-12">
        <p id="nextRaceLabel" class="text-white/95 text-lg font-semibold"></p>
      </div>
      <div class="max-w-3xl mx-auto grid grid-cols-4 gap-4 text-center mt-3">
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="d" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Dager</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="h" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Timer</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="m" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Min</div>
        </div>
        <div class="rounded-xl bg-white/15 border border-white/25 p-4 backdrop-blur-sm">
          <div id="s" class="text-4xl font-extrabold text-[var(--accent)]">0</div>
          <div class="text-sm uppercase tracking-wide text-white mt-1">Sek</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Arrangementer -->
  <section id="arrangementer" class="py-16 bg-slate-50">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-4">Kommende arrangementer</h2>

      <div class="inline-flex rounded-2xl bg-white shadow p-1 mb-4" role="tablist" aria-label="Visning">
        <button id="tab-list" class="px-4 py-2 rounded-xl font-semibold" role="tab" aria-selected="true" aria-controls="panel-list">Liste</button>
        <button id="tab-cal" class="px-4 py-2 rounded-xl font-semibold" role="tab" aria-selected="false" aria-controls="panel-cal">Kalender</button>
        <button id="tab-map" class="px-4 py-2 rounded-xl font-semibold" role="tab" aria-selected="false" aria-controls="panel-map">Kart</button>
      </div>

      <div class="card p-4 sm:p-6">
        <div class="grid gap-3 sm:grid-cols-4 items-end">
          <label class="sm:col-span-2">
            <span class="text-sm font-semibold">Søk</span>
            <input id="q" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Søk på navn eller sted"/>
          </label>
          <label>
            <span class="text-sm font-semibold">Måned</span>
            <select id="month" class="mt-1 w-full rounded-xl border px-3 py-2">
              <option value="">Alle</option>
            </select>
          </label>
          <label>
            <span class="text-sm font-semibold">Region</span>
            <select id="region" class="mt-1 w-full rounded-xl border px-3 py-2">
              <option value="">Alle</option>
            </select>
          </label>
        </div>
        <div class="mt-4 flex flex-wrap gap-3">
          <button id="resetFilters" class="rounded-full border px-4 py-2 font-semibold hover:bg-slate-50">Nullstill</button>
          <button id="togglePast" class="rounded-full btn-brand px-4 py-2 font-semibold" aria-pressed="false">Vis tidligere løp</button>
        </div>
      </div>

      <div id="eventsSummary" class="mt-4 text-slate-600"></div>

      <div id="panel-list" role="tabpanel" aria-labelledby="tab-list" class="mt-4">
        <div id="eventsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6" aria-live="polite"></div>
        <p id="eventsEmpty" class="hidden text-slate-600">Ingen arrangementer matcher filtrene.</p>
      </div>

      <div id="panel-cal" role="tabpanel" aria-labelledby="tab-cal" hidden class="mt-6">
        <div class="flex items-center justify-between mb-3">
          <button id="calPrev" class="rounded-full border px-3 py-2 font-semibold hover:bg-slate-50">Forrige</button>
          <h3 id="calTitle" class="text-xl font-bold"></h3>
          <button id="calNext" class="rounded-full border px-3 py-2 font-semibold hover:bg-slate-50">Neste</button>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
      </div>

      <div id="panel-map" role="tabpanel" aria-labelledby="tab-map" hidden class="mt-6">
        <div id="map" class="w-full h-[520px] rounded-2xl overflow-hidden border"></div>
        <p class="mt-2 text-sm text-slate-600">Tips: klikk på markørene for info og påmeldingslenke.</p>
      </div>
    </div>
  </section>

  <!-- Resultater -->
  <section id="resultater" class="py-16">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-4">Finn ditt resultat</h2>
      <div class="card p-4 sm:p-6">
        <div class="grid sm:grid-cols-3 gap-3">
          <input id="resName" class="rounded-xl border px-3 py-2" placeholder="Navn på løp eller deltaker" />
          <input id="resYear" class="rounded-xl border px-3 py-2" placeholder="År (valgfritt, f.eks. 2025)" />
          <button id="resSearch" class="btn-brand rounded-xl px-4 py-2 font-semibold">Søk resultater</button>
        </div>
        <p class="text-slate-600 mt-3">Vi åpner smarte søk i nye faner, slik at du raskt finner resultatene dine.</p>
        <div id="resLinks" class="mt-4 grid gap-2"></div>
      </div>
    </div>
  </section>

  <!-- Vær fast seksjon (eksempel) -->
  <section id="vaer" class="py-16 bg-slate-50">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-4">Værmelding (Oslo – eksempel)</h2>
      <iframe src="https://www.pent.no/Oslo" width="100%" height="600" style="border:none; border-radius:10px;"></iframe>
    </div>
  </section>

  <!-- Kontakt -->
  <section id="kontakt" class="py-16">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)]">Kontakt oss</h2>
      <p class="mt-2 text-slate-700">Spørsmål om løp, samarbeid eller presse? Send oss e-post – vi svarer raskt.</p>
      <div class="mt-6 flex flex-wrap items-center gap-4 justify-center">
        <a class="btn-brand rounded-full px-6 py-3 font-semibold" href="mailto:post@runnorway.no">post@runnorway.no</a>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq" class="py-16 bg-slate-50">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-3xl sm:text-4xl font-bold text-[var(--brand)] mb-6 text-center">Ofte stilte spørsmål</h2>
      <details class="card p-4">
        <summary class="cursor-pointer font-semibold text-[var(--brand)]">Hvordan melder jeg på?</summary>
        <p class="mt-2 text-slate-700">Trykk inn på det løpet du vil delta på og trykk så «Delta».</p>
      </details>
    </div>
  </section>

  <footer class="py-10 bg-[var(--brand)] text-white text-center">
    <p>© <span id="year"></span> RunNorway</p>
  </footer>

  <!-- Modal: Løpsdetaljer -->
  <div id="eventModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header px-5 py-4 flex items-center justify-between">
        <h3 id="modalTitle" class="text-xl font-bold text-[var(--brand)]">Løpsnavn</h3>
        <button id="modalClose" class="rounded-full border px-3 py-1">Lukk</button>
      </div>
      <div id="modalBody" class="p-5 grid gap-5"></div>
    </div>
  </div>

  <!-- Seed-data (brukes hvis EQ Timing ikke kan lastes i nettleser) -->
  <script id="events-seed" type="application/json">[
    {"title":"Bergen City Mile","date":"2026-04-12","location":"Bergen sentrum","region":"Vestland","distances":["5K","10K","Familie"],"image":"https://images.unsplash.com/photo-1552674605-db6ffd4facb0?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Oslo FjordRun 10K","date":"2026-05-03","location":"Bygdøy, Oslo","region":"Oslo","distances":["10K"],"image":"https://images.unsplash.com/photo-1541963694-3f4e68f1b7a1?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Trondheim City Trail","date":"2026-05-18","location":"Bymarka, Trondheim","region":"Trøndelag","distances":["8K","16K"],"image":"https://images.unsplash.com/photo-1520975922203-b85e66f2aa64?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Stavanger Strand 5K","date":"2026-06-07","location":"Stavanger sentrum","region":"Rogaland","distances":["5K"],"image":"https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"},
    {"title":"Midnight Sun Half","date":"2026-06-21","location":"Tromsøya","region":"Troms og Finnmark","distances":["21K","10K"],"image":"https://images.unsplash.com/photo-1541625602330-2277a4c46182?q=80&w=1200&auto=format&fit=crop","signup_url":"#","details_url":"#"}
  ]</script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const fmtDate = iso => new Date(iso).toLocaleDateString('no-NO',{year:'numeric',month:'long',day:'numeric'});
    function cityToPentUrl(location){
      if(!location) return null;
      let city = location.split(',')[0].trim();
      const map = {'Bergen sentrum':'Bergen','Stavanger sentrum':'Stavanger','Bymarka, Trondheim':'Trondheim','Tromsøya':'Tromsø'};
      if(map[location]) city = map[location];
      return `https://www.pent.no/${encodeURIComponent(city)}`;
    }
    const geo={'Oslo':[59.9139,10.7522],'Bygdøy, Oslo':[59.9036,10.6785],'Bergen sentrum':[60.39299,5.32415],'Bymarka, Trondheim':[63.401,10.276],'Trondheim':[63.4305,10.3951],'Stavanger sentrum':[58.9690,5.7331],'Tromsøya':[69.6492,18.9553]};

    const state={all:[],showPast:false,filters:{q:'',month:'',region:''},view:'list',cal:new Date(), nextTarget:null, nextEvent:null};
    function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

    async function fetchEqTimingDirect(){
      const url='https://api.eqtiming.com/api/v1/Events';
      const ctrl=new AbortController();
      const t=setTimeout(()=>ctrl.abort(), 8000);
      try{
        const r=await fetch(url,{headers:{accept:'application/json'},mode:'cors',signal:ctrl.signal});
        clearTimeout(t);
        if(!r.ok) throw new Error('status '+r.status);
        const data=await r.json();
        const list = Array.isArray(data) ? data : Array.isArray(data?.Items) ? data.Items : [];
        const onlyNO = list.filter(e => String(e.Country||'').toUpperCase()==='NO' || /Norge|Norway/i.test(e.Country||''));
        const mapped = onlyNO.map(e=>{
          const title = e.Name || e.EventName || e.Title || 'Uten navn';
          const dateIso = String(e.StartDate || e.Date || e.StartTime || '').slice(0,10);
          const city = e.City || e.Location || '';
          const region = e.County || e.Region || '';
          const lat = typeof e.Latitude === 'number' ? e.Latitude : undefined;
          const lng = typeof e.Longitude === 'number' ? e.Longitude : undefined;
          const signup = e.RegistrationUrl || e.SignupUrl || e.Url || '';
          const website = e.Website || e.Homepage || e.Url || '';
          return {
            title, date:dateIso, location:city, region,
            distances:Array.isArray(e.Distances)?e.Distances:[],
            image:e.ImageUrl || e.LogoUrl || 'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?q=80&w=1200&auto=format&fit=crop',
            signup_url:signup, details_url:website, lat, lng, _source:'eqtiming'
          };
        }).filter(e => e.date && !Number.isNaN(new Date(e.date)));
        // sorter og dedupliser
        const key=e=>`${e.title}|${e.date}`;
        const seen=new Set();
        const cleaned=[];
        for(const e of mapped.sort((a,b)=>new Date(a.date)-new Date(b.date))){
          const k=key(e); if(seen.has(k)) continue; seen.add(k); cleaned.push(e);
        }
        return cleaned;
      }catch(err){
        return null;
      }
    }

    async function loadEvents(){
      let fromEq = await fetchEqTimingDirect();
      if(Array.isArray(fromEq) && fromEq.length){
        state.all = fromEq;
      } else {
        state.all = JSON.parse(document.getElementById('events-seed').textContent);
      }
      renderFilters();
      setView('list');
      initCountdownToNext();
    }

    function initCountdownToNext(){
      const today=new Date(); today.setHours(0,0,0,0);
      const upcoming = state.all
        .map(e=>({...e,_d:new Date(e.date)}))
        .filter(e=>!isNaN(e._d) && e._d>=today)
        .sort((a,b)=>a._d-b._d);
      state.nextEvent = upcoming[0] || null;
      const label = document.getElementById('nextRaceLabel');
      if(state.nextEvent){
        state.nextTarget = new Date(state.nextEvent.date+'T09:00:00');
        label.textContent = `Neste løp: ${state.nextEvent.title} — ${fmtDate(state.nextEvent.date)}`;
      } else {
        const fallback = new Date(); fallback.setDate(fallback.getDate()+60);
        state.nextTarget = fallback;
        label.textContent = `Neste løp: annonseres snart`;
      }
      tick(); clearInterval(window.__countInt__); window.__countInt__=setInterval(tick,1000);
    }

    function tick(){
      const target = state.nextTarget || new Date();
      const now=new Date(); let diff=Math.max(0,target-now);
      const d=Math.floor(diff/86400000); diff-=d*86400000;
      const h=Math.floor(diff/3600000);  diff-=h*3600000;
      const m=Math.floor(diff/60000);    diff-=m*60000;
      const s=Math.floor(diff/1000);
      document.getElementById("d").textContent=d;
      document.getElementById("h").textContent=h;
      document.getElementById("m").textContent=m;
      document.getElementById("s").textContent=s;
    }

    function renderFilters(){
      const months=new Set(), regions=new Set();
      for(const ev of state.all){ const dd=new Date(ev.date); if(!isNaN(dd)) months.add(monthKey(dd)); if(ev.region) regions.add(ev.region); }
      const monthSel=document.getElementById('month'); const regionSel=document.getElementById('region');
      monthSel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
      regionSel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
      for(const m of Array.from(months).sort()){
        const [y,mm]=m.split('-'); const o=document.createElement('option');
        o.value=m; o.textContent=new Date(`${y}-${mm}-01`).toLocaleDateString('no-NO',{month:'long',year:'numeric'});
        monthSel.appendChild(o);
      }
      for(const r of Array.from(regions).sort()){ const o=document.createElement('option'); o.value=r; o.textContent=r; regionSel.appendChild(o); }
    }

    function filtered(){
      const today=new Date(); today.setHours(0,0,0,0);
      let list=[...state.all];
      if(!state.showPast) list=list.filter(e=>new Date(e.date)>=today);
      if(state.filters.q){
        const q=state.filters.q.toLowerCase();
        list=list.filter(e=>`${e.title} ${e.location}`.toLowerCase().includes(q));
      }
      if(state.filters.month){ list=list.filter(e=>monthKey(new Date(e.date))===state.filters.month); }
      if(state.filters.region){ list=list.filter(e=>e.region===state.filters.region); }
      return list.sort((a,b)=>new Date(a.date)-new Date(b.date));
    }

    function renderList(){
      const items=filtered(); const grid=document.getElementById('eventsGrid'); const empty=document.getElementById('eventsEmpty');
      grid.innerHTML=''; document.getElementById('eventsSummary').textContent=`Viser ${items.length} arrangementer`;
      if(items.length===0){ empty.classList.remove('hidden'); return; } else empty.classList.add('hidden');

      items.forEach((ev, idx)=>{
        const el=document.createElement('article'); el.className='card overflow-hidden';
        el.innerHTML=`
          <img src="${ev.image}" alt="${ev.title}" class="h-44 w-full object-cover"/>
          <div class="p-6">
            <div class="text-xs uppercase tracking-wide text-slate-500">${ev.region||''}</div>
            <h3 class="text-xl font-semibold mt-1 link-brand">${ev.title}</h3>
            <p class="text-sm text-slate-600 mt-1">${fmtDate(ev.date)} • ${ev.location}</p>
            <p class="text-sm mt-2">${(ev.distances||[]).join(', ')}</p>
            <div class="mt-3 flex flex-wrap gap-3">
              ${ev.signup_url?`<a href='${ev.signup_url}' class='btn-brand rounded-full px-4 py-2 text-sm font-semibold' target="_blank" rel="noopener">Delta</a>`:''}
              <button class="rounded-full border px-4 py-2 text-sm font-semibold hover:bg-slate-50" onclick='openEvent(${JSON.stringify(ev).replace(/'/g,"&#39;")})'>Les mer</button>
              <button class="rounded-full border px-4 py-2 text-sm font-semibold hover:bg-slate-50" onclick="showInlineWeather(${idx})">Se vær</button>
            </div>
            <div id='inline-weather-${idx}' class='mt-4 hidden'></div>
          </div>`;
        grid.appendChild(el);
      });
    }

    function showInlineWeather(i){
      const items = filtered();
      const ev = items[i]; if(!ev) return;
      const url = cityToPentUrl(ev.location);
      const box = document.getElementById(`inline-weather-${i}`);
      if(!url){ box.innerHTML = `<p class="text-sm text-slate-600">Fant ikke sted for vær.</p>`; }
      else {
        box.innerHTML = `<h4 class="text-lg font-semibold mb-2 link-brand">Værmelding (${ev.location})</h4>
                         <iframe src="${url}" width="100%" height="520" style="border:none; border-radius:10px;"></iframe>`;
      }
      box.classList.remove('hidden'); box.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
    function renderCalendar(){
      const current=new Date(state.cal.getFullYear(), state.cal.getMonth(), 1);
      const y=current.getFullYear(), m=current.getMonth();
      document.getElementById('calTitle').textContent=current.toLocaleDateString('no-NO',{month:'long',year:'numeric'});
      const grid=document.getElementById('calendarGrid'); grid.innerHTML='';
      const wk=['Man','Tir','Ons','Tor','Fre','Lør','Søn'];
      for(const w of wk){ const h=document.createElement('div'); h.className='text-xs font-semibold text-slate-500 text-center'; h.textContent=w; grid.appendChild(h); }
      const firstDow=(new Date(y,m,1).getDay()+6)%7; const dim=daysInMonth(y,m);
      for(let i=0;i<firstDow;i++){ grid.appendChild(document.createElement('div')); }
      const items=filtered();
      for(let day=1; day<=dim; day++){
        const cell=document.createElement('div'); cell.className='rounded-xl bg-white shadow p-2 min-h-[84px]';
        const label=document.createElement('div'); label.className='text-sm font-semibold'; label.textContent=String(day); cell.appendChild(label);
        const dateStr= new Date(y,m,day).toISOString().slice(0,10);
        const todays = items.filter(e=> e.date===dateStr || new Date(e.date).toDateString()===new Date(dateStr).toDateString());
        for(const ev of todays){ const a=document.createElement('div'); a.className='mt-1 text-xs'; a.textContent=ev.title; cell.appendChild(a); }
        grid.appendChild(cell);
      }
    }

    let map, markersLayer;
    function ensureMap(){
      if(map) return;
      map=L.map('map'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
      markersLayer=L.layerGroup().addTo(map);
    }
    function renderMap(){
      ensureMap(); markersLayer.clearLayers();
      const items=filtered(); const points=[];
      const lookup=loc=> geo[loc] || geo[(loc||'').split(',')[0]] || null;
      for(const ev of items){
        const latlng=(ev.lat&&ev.lng)?[ev.lat,ev.lng]:lookup(ev.location);
        if(!latlng) continue; points.push(latlng);
        L.marker(latlng).addTo(markersLayer).bindPopup(`<strong>${ev.title}</strong><br>${fmtDate(ev.date)} • ${ev.location}`);
      }
      if(points.length){ map.fitBounds(L.latLngBounds(points),{padding:[30,30]}); } else { map.setView([64.5,11.5],5); }
      setTimeout(()=>map.invalidateSize(),0);
    }

    function setView(v){
      state.view=v;
      ['list','cal','map'].forEach(id=>{
        document.getElementById(`tab-${id}`).setAttribute('aria-selected', String(id===v));
        document.getElementById(`panel-${id}`).hidden = id!==v;
      });
      if(v==='list') renderList();
      if(v==='cal') renderCalendar();
      if(v==='map') renderMap();
    }

    // Resultater
    document.getElementById('resSearch')?.addEventListener('click', ()=>{
      const name = (document.getElementById('resName').value||'').trim();
      const year = (document.getElementById('resYear').value||'').trim();
      const q = encodeURIComponent([name, year].filter(Boolean).join(' '));
      const engines = [
        {label:'Google (norsk)', url:`https://www.google.com/search?q=${q}+resultater+løp`},
        {label:'Bing', url:`https://www.bing.com/search?q=${q}+resultater+løp`},
        {label:'DuckDuckGo', url:`https://duckduckgo.com/?q=${q}+resultater+løp`}
      ];
      const box = document.getElementById('resLinks'); box.innerHTML='';
      engines.forEach(e=>{
        const a=document.createElement('a'); a.href=e.url; a.target='_blank'; a.rel='noopener';
        a.textContent=`Åpne i ${e.label}`; a.className='underline text-[var(--brand)]';
        const p=document.createElement('p'); p.appendChild(a); box.appendChild(p);
      });
    });

    // Modal
    const modalBackdrop = document.getElementById('eventModalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    document.getElementById('modalClose').addEventListener('click', ()=> modalBackdrop.style.display='none');
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) modalBackdrop.style.display='none'; });

    function openEvent(ev){
      modalTitle.textContent = ev.title;
      const pent = cityToPentUrl(ev.location);
      const g = geo[ev.location] || geo[(ev.location||'').split(',')[0]] || (ev.lat&&ev.lng?[ev.lat,ev.lng]:null);

      modalBody.innerHTML = `
        <div class="grid lg:grid-cols-2 gap-5">
          <div>
            <div class="text-sm text-slate-600 mb-1">${ev.region||''}</div>
            <div class="text-lg font-semibold">${fmtDate(ev.date)} • ${ev.location||''}</div>
            <div class="mt-2 text-slate-700">${(ev.distances||[]).join(', ')}</div>
            <div class="mt-4 flex flex-wrap gap-3">
              ${ev.signup_url?`<a href="${ev.signup_url}" class="btn-brand rounded-full px-4 py-2 font-semibold" target="_blank" rel="noopener">Delta</a>`:''}
              ${ev.details_url?`<a href="${ev.details_url}" class="rounded-full border px-4 py-2 font-semibold hover:bg-slate-50" target="_blank" rel="noopener">Nettside</a>`:''}
            </div>
            ${pent ? `<h4 class="text-[var(--brand)] font-bold mt-6 mb-2">Værmelding (${ev.location})</h4>
                      <iframe src="${pent}" width="100%" height="420" style="border:none; border-radius:10px;"></iframe>` : ''}
          </div>
          <div><div id="modalMap" class="h-[380px] rounded-2xl border"></div></div>
        </div>
      `;
      modalBackdrop.style.display='flex';
      setTimeout(()=>{
        const m = L.map('modalMap');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'© OpenStreetMap'}).addTo(m);
        if(g){ m.setView(g, 12); L.marker(g).addTo(m).bindPopup(ev.title); } else { m.setView([64.5,11.5],5); }
      }, 50);
    }

    // Init
    document.addEventListener('DOMContentLoaded',()=>{
      loadEvents();

      document.getElementById('q').addEventListener('input',e=>{state.filters.q=e.target.value; setView(state.view);});
      document.getElementById('month').addEventListener('change',e=>{state.filters.month=e.target.value; setView(state.view);});
      document.getElementById('region').addEventListener('change',e=>{state.filters.region=e.target.value; setView(state.view);});
      document.getElementById('resetFilters').addEventListener('click',()=>{ state.filters={q:'',month:'',region:''}; q.value=''; month.value=''; region.value=''; setView(state.view); });
      document.getElementById('togglePast').addEventListener('click',e=>{ state.showPast=!state.showPast; e.currentTarget.setAttribute('aria-pressed', String(state.showPast)); e.currentTarget.textContent= state.showPast? 'Skjul tidligere løp':'Vis tidligere løp'; setView(state.view); });

      document.getElementById('tab-list').addEventListener('click',()=>setView('list'));
      document.getElementById('tab-cal').addEventListener('click',()=>setView('cal'));
      document.getElementById('tab-map').addEventListener('click',()=>setView('map'));
      document.getElementById('calPrev').addEventListener('click',()=>{ state.cal.setMonth(state.cal.getMonth()-1); renderCalendar(); });
      document.getElementById('calNext').addEventListener('click',()=>{ state.cal.setMonth(state.cal.getMonth()+1); renderCalendar(); });
    });
  </script>
</body>
</html>
